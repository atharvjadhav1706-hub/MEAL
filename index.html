<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pro FitHub: Perfect Dim</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
    /* --- CORE VARIABLES (DARK MODE) --- */
    :root {
        --bg: #000000;
        --text: #ffffff;
        --text-sec: #cccccc;
        --card-bg: rgba(20, 20, 20, 0.6);
        --card-border: 1px solid rgba(255, 255, 255, 0.08);
        --input-bg: #080808;
        --modal-bg: #111111;
        
        --g-orange: linear-gradient(to right, rgba(255, 69, 0, 0.4), rgba(0, 0, 0, 0.8));
        --g-green:  linear-gradient(to right, rgba(0, 200, 83, 0.4), rgba(0, 0, 0, 0.8));
        --g-blue:   linear-gradient(to right, rgba(41, 121, 255, 0.4), rgba(0, 0, 0, 0.8));
        --g-purple: linear-gradient(to right, rgba(191, 90, 242, 0.4), rgba(0, 0, 0, 0.8));
        --g-cyan:   linear-gradient(to right, rgba(0, 229, 255, 0.4), rgba(0, 0, 0, 0.8));
        --g-gold:   linear-gradient(to right, rgba(255, 215, 0, 0.4), rgba(0, 0, 0, 0.8));
        --g-red:    linear-gradient(to right, rgba(255, 59, 48, 0.4), rgba(0, 0, 0, 0.8));
        
        --shadow-depth: 0 10px 30px -10px rgba(0,0,0,0.8);
        --text-glow: 0 4px 15px rgba(0,0,0,1);
        --emoji-op: 0.25;
        --emoji-filter: grayscale(0.2) drop-shadow(0 0 10px rgba(255,255,255,0.1));
        
        --tag-bg: rgba(255,255,255,0.08);
        --bullet-color: #FF3B30;
        
        --font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --border-radius: 26px;
    }

    /* --- LIGHT MODE VARIABLES --- */
    body.light-mode {
        --bg: #F0F2F5;
        --text: #111111;
        --text-sec: #444444;
        --card-bg: #ffffff;
        --card-border: 1px solid rgba(0, 0, 0, 0.08);
        --input-bg: #ffffff;
        --modal-bg: #ffffff;

        --g-orange: linear-gradient(to right, #FF8A65, #BF360C);
        --g-green:  linear-gradient(to right, #4ADE80, #14532D);
        --g-blue:   linear-gradient(to right, #60A5FA, #1E3A8A);
        --g-purple: linear-gradient(to right, #C084FC, #581C87);
        --g-cyan:   linear-gradient(to right, #22D3EE, #0F766E);
        --g-gold:   linear-gradient(to right, #FACC15, #854D0E);
        --g-red:    linear-gradient(to right, #FF8A80, #B71C1C);
        
        --shadow-depth: 0 10px 25px -5px rgba(0,0,0,0.15);
        --text-glow: 0 2px 4px rgba(0,0,0,0.3);
        --emoji-op: 0.5;
        --emoji-filter: none;
        
        --tag-bg: #E0E0E0;
        --bullet-color: #000000;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
    
    body { background-color: var(--bg); color: var(--text); font-family: var(--font); margin: 0; padding: 0; padding-bottom: 50px; overflow-x: hidden; transition: background-color 0.3s ease, color 0.3s ease; }

    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes float { 0% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-8px) rotate(3deg); } 100% { transform: translateY(0px) rotate(0deg); } }
    @keyframes pulse-border { 0% { border-color: var(--accent-color); } 50% { border-color: #fff; box-shadow: 0 0 15px var(--accent-color); } 100% { border-color: var(--accent-color); } }
    @keyframes barMove { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }

    .header { padding: 30px 24px 15px 24px; display: flex; justify-content: space-between; align-items: center; }
    .welcome-sub { font-size: 0.7rem; font-weight: 700; color: var(--text-sec); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 2px; }
    .app-title { font-size: 1.6rem; font-weight: 900; letter-spacing: -0.5px; color: var(--text); }
    body:not(.light-mode) .app-title { text-shadow: var(--text-glow); }
    
    .head-actions { display: flex; gap: 12px; }
    .icon-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--card-bg); border: var(--card-border); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; transition: 0.2s; box-shadow: var(--shadow-depth); color: var(--text); }
    .icon-btn:active { transform: scale(0.92); }

    .grid { padding: 0 24px; display: flex; flex-direction: column; gap: 16px; }
    .card { border-radius: var(--border-radius); padding: 22px; position: relative; overflow: hidden; cursor: pointer; display: flex; flex-direction: column; justify-content: center; border: var(--card-border); backdrop-filter: blur(10px); box-shadow: var(--shadow-depth); transition: transform 0.2s; }
    .card:active { transform: scale(0.98); opacity: 0.9; }

    .bg-icon { position: absolute; right: 15px; top: 50%; margin-top: -30px; font-size: 4.5rem; opacity: var(--emoji-op); z-index: 0; filter: var(--emoji-filter); pointer-events: none; animation: float 5s ease-in-out infinite; }
    .card-content { position: relative; z-index: 2; width: 100%; }

    body.light-mode .c-streak, body.light-mode .c-meal, body.light-mode .c-maida, body.light-mode .c-history, body.light-mode .c-water, body.light-mode .c-shop { color: #ffffff !important; }
    body.light-mode .streak-lbl, body.light-mode .c-meal-title, body.light-mode .streak-val, body.light-mode .sc-val, body.light-mode .sc-lbl { color: #ffffff !important; opacity: 1 !important; text-shadow: 0 2px 5px rgba(0,0,0,0.2) !important; }

    .c-streak { background: var(--g-orange); border-color: rgba(255, 69, 0, 0.3); }
    .c-meal { background: var(--g-green); border-color: rgba(0, 200, 83, 0.3); }
    .c-water { background: var(--g-cyan); border-color: rgba(0, 229, 255, 0.3); }
    .c-shop { background: var(--g-purple); border-color: rgba(191, 90, 242, 0.3); }
    .c-maida { background: var(--g-blue); border-color: rgba(41, 121, 255, 0.3); }
    .c-history { background: var(--g-gold); border-color: rgba(255, 215, 0, 0.3); }

    .streak-lbl { font-size: 0.7rem; font-weight: 800; opacity: 0.7; letter-spacing: 1.5px; text-transform: uppercase; color: #ddd; text-shadow: var(--text-glow); }
    .streak-val { font-size: 2.6rem; font-weight: 900; line-height: 1; display:flex; align-items:baseline; gap:6px; margin-top: 6px; text-shadow: var(--text-glow); }
    
    .c-meal-title { font-size: 1.5rem; font-weight: 900; line-height: 1; margin-top: 6px; letter-spacing: -0.3px; text-shadow: var(--text-glow); max-width: calc(100% - 100px); }

    .mc-prog { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); width: 85px; height: 85px; display: flex; align-items: center; justify-content: center; z-index: 2; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
    .mc-prog svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .mc-bg { stroke: rgba(255,255,255,0.3); }
    .mc-fill { stroke: #fff; stroke-dasharray: 175; stroke-dashoffset: 175; transition: 1s; stroke-linecap: round; }
    .mc-pct { font-size: 0.9rem; font-weight: 900; position: absolute; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

    .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .small-card { min-height: 150px; border-radius: var(--border-radius); padding: 20px 10px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; backdrop-filter: blur(10px); border: var(--card-border); background: var(--card-bg); }
    body.light-mode .small-card.c-water { background: var(--g-cyan); color: #fff; }
    body.light-mode .small-card.c-shop { background: var(--g-purple); color: #fff; }
    
    .small-card .bg-icon { font-size: 3.5rem; right: -10px; bottom: 5px; top: auto; opacity: 0.2; }
    .sc-val { font-size: 1.6rem; font-weight: 900; color: inherit; margin: 4px 0; text-shadow: var(--text-glow); }
    .sc-lbl { font-size: 0.65rem; color: inherit; opacity: 0.9; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; text-shadow: var(--text-glow); }

    .meal-list { padding: 0 24px; margin-top: 10px; }
    .sticky-bar-container { position: sticky; top: 0; z-index: 100; background: rgba(var(--bg-rgb), 0.95); backdrop-filter: blur(15px); padding: 15px 24px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    body.light-mode .sticky-bar-container { background: rgba(240, 242, 245, 0.95); border-bottom: 1px solid rgba(0,0,0,0.05); }

    .sb-info { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
    .sb-title { font-size: 0.8rem; font-weight: 800; color: var(--text-sec); letter-spacing: 1px; text-transform: uppercase; }
    .sb-val { font-size: 1.1rem; font-weight: 900; color: var(--text); }
    .sb-track { width: 100%; height: 8px; background: rgba(128,128,128,0.2); border-radius: 10px; overflow: hidden; position: relative; }
    .sb-fill { height: 100%; width: 0%; border-radius: 10px; background: linear-gradient(90deg, #FF3B30, #FF9500, #FFCC00, #4CD964, #5AC8FA, #007AFF, #5856D6, #FF2D55); background-size: 400% 100%; animation: barMove 4s linear infinite; transition: width 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }

    .meal-card { background: var(--card-bg); border: var(--card-border); border-radius: 20px; margin-bottom: 20px; position: relative; overflow: hidden; padding-left: 5px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: var(--shadow-depth); color: var(--text); }
    .meal-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: var(--accent-color); }
    .meal-card.highlight { border: 2px solid var(--accent-color) !important; box-shadow: 0 0 25px rgba(var(--accent-rgb), 0.2); transform: scale(1.01); z-index: 5; animation: pulse-border 2s infinite; background: var(--card-bg); }
    
    .next-badge { position: absolute; top: 0; right: 55px; background: #FF3B30; color: #fff; font-size: 0.6rem; font-weight: 900; padding: 5px 12px; border-bottom-left-radius: 12px; display: none; text-transform: uppercase; z-index: 10; letter-spacing: 0.5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); text-shadow: none !important; }
    .meal-card.highlight .next-badge { display: block; }

    .mc-content { padding: 20px; cursor: pointer; }
    .mc-top { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; padding-right: 40px; }
    .mc-time { color: var(--accent-color); font-weight: 800; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; text-shadow:none; }
    .mc-cal { background: rgba(128,128,128,0.1); color: var(--text-sec); padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 0.7rem; border: 1px solid rgba(128,128,128,0.2); }
    
    .mc-title { font-size: 1.4rem; font-weight: 800; color: var(--text); margin-bottom: 15px; letter-spacing: -0.3px; line-height: 1.2; padding-right: 40px; text-shadow:none; max-width: calc(100% - 40px); word-wrap: break-word; }

    .ing-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed rgba(128,128,128,0.2); }
    .ing-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .ing-left { display: flex; align-items: center; color: var(--text-sec); font-weight: 600; font-size: 0.95rem; }
    .ing-bullet { width: 6px; height: 6px; border-radius: 50%; background: var(--bullet-color); margin-right: 12px; flex-shrink: 0; }
    .ing-tag { background: var(--tag-bg); color: var(--text); font-weight: 700; font-size: 0.8rem; padding: 5px 12px; border-radius: 8px; min-width: 60px; text-align: center; border: 1px solid rgba(128,128,128,0.15); }

    .check-box { position: absolute; top: 18px; right: 18px; z-index: 10; width: 34px; height: 34px; border: 2px solid var(--text-sec); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; background: var(--bg); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 1.1rem; color: transparent; }
    .check-box:hover { border-color: var(--text); transform: scale(1.1); }
    .meal-card.checked { opacity: 0.5; filter: grayscale(1); }
    .meal-card.checked .check-box { background: #00E676; border-color: #00E676; color: #000; box-shadow: 0 0 15px rgba(0, 230, 118, 0.4); }

    /* NEW DELETE BUTTON FOR CUSTOM LOGS */
    .del-box { position: absolute; top: 18px; right: 18px; z-index: 10; width: 34px; height: 34px; border: 2px solid #FF3B30; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; background: var(--bg); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 1rem; color: #FF3B30; font-weight: 900;}
    .del-box:hover { background: #FF3B30; color: #fff; transform: scale(1.1); box-shadow: 0 0 15px rgba(255, 59, 48, 0.4); }

    .page { display: none; padding: 0; animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .page.active { display: block; }
    
    .nav-back { margin: 0 24px 15px 24px; display: inline-flex; align-items: center; gap: 8px; background: var(--card-bg); padding: 12px 24px; border-radius: 30px; font-weight: 700; color: var(--text); cursor: pointer; border: var(--card-border); transition: 0.2s; box-shadow: var(--shadow-depth); }
    .nav-back:active { transform: scale(0.95); }

    .shop-row, .hist-row { background: var(--card-bg); padding: 18px; border-radius: 16px; margin-bottom: 10px; border: var(--card-border); display: flex; justify-content: space-between; align-items: center; cursor:pointer; box-shadow: var(--shadow-depth); color:var(--text); }
    .shop-row.done { opacity: 0.3; text-decoration: line-through; }
    .shop-qty { background: rgba(0, 230, 118, 0.1); padding: 5px 12px; border-radius: 8px; font-weight: 700; color: #00E676; font-size: 0.9rem; }
    
    .hist-row { cursor: default; }
    .hist-date { font-weight: 700; opacity: 0.8; font-size: 0.9rem; }
    .hist-data { text-align: right; }
    .hist-val { font-weight: 800; font-size: 1rem; color: #fff; }
    body.light-mode .hist-val { color: #000; }
    .hist-sub { font-size: 0.75rem; color: var(--text-sec); font-weight: 600; }

    .maida-btn { width: 100%; padding: 22px; margin-top: 25px; background: #fff; color: #000; font-weight: 900; font-size: 1.1rem; border: none; border-radius: 20px; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    body.light-mode .maida-btn { background: #111; color: #fff; }
    .maida-btn:active { transform: scale(0.98); opacity: 0.9; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-box { background: var(--modal-bg); padding: 30px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; border-radius: 28px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); color: var(--text); }
    body.light-mode .modal-box { border: 1px solid rgba(0,0,0,0.1); background: #fff; }
    h2 { margin-top: 0; color: var(--text); font-size: 1.5rem; }
    
    input, textarea { width: 100%; padding: 18px; background: var(--input-bg); border: 1px solid rgba(128,128,128,0.2); color: var(--text); border-radius: 14px; margin-bottom: 15px; font-family: var(--font); font-size: 1rem; outline: none; }
    input:focus { border-color: var(--text); }
    textarea { height: 100px; font-family: monospace; font-size: 0.8rem; line-height: 1.4; color: #00E676; resize: none; }
    
    .btn { width: 100%; padding: 18px; background: var(--text); color: var(--bg); font-weight: 800; border: none; border-radius: 16px; cursor: pointer; margin-top: 5px; font-size: 1rem; }
    .btn:active { opacity: 0.8; }
    .btn-sec { background: transparent; border: 1px solid var(--text-sec); color: var(--text); margin-top: 12px; }

    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color:#fff; padding: 12px 24px; border-radius: 40px; z-index: 3000; border: 1px solid #444; opacity: 0; transition: 0.3s; pointer-events: none; font-weight: 700; display: flex; gap: 10px; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .toast.show { opacity: 1; top: 50px; }

    .water-actions { display: flex; gap: 5px; margin-top: 15px; }
    .water-btn { flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: inherit; padding: 12px 5px; border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.2s; backdrop-filter: blur(4px); white-space: nowrap; }
    .water-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.4); }

    /* --- TOGGLE CSS --- */
    .toggle-wrapper { display: flex; align-items: center; gap: 10px; background: var(--card-bg); border: var(--card-border); padding: 8px 16px; border-radius: 30px; cursor: pointer; }
    .switch-track { width: 44px; height: 24px; background: #FF3B30; border-radius: 12px; position: relative; transition: 0.3s; }
    .switch-track.is-veg { background: #30D158; }
    .switch-thumb { width: 20px; height: 20px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .switch-track.is-veg .switch-thumb { transform: translateX(20px); }
    .toggle-label { font-size: 0.75rem; font-weight: 800; letter-spacing: 1px; color: var(--text); text-transform: uppercase; width: 65px; text-align: center; }
</style>
</head>
<body>

<div class="toast" id="toast"><span>‚úÖ</span> <span id="toastMsg">Saved</span></div>

<div id="p-home" class="page active">
    <div class="header">
        <div onclick="editName()">
            <div class="welcome-sub">WELCOME BACK,</div>
            <div class="app-title" id="userName">ATHARV ‚úé</div>
        </div>
        <div class="head-actions">
            <div class="icon-btn" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è</div>
            <div class="icon-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</div>
        </div>
    </div>

    <div class="grid">
        <div class="card c-streak">
            <div class="bg-icon">üèÜ</div>
            <div class="card-content">
                <div class="streak-lbl">CURRENT STREAK</div>
                <div class="streak-val"><span id="dispStreak">0</span><span style="font-size:1.4rem; opacity:0.9; font-weight:800; margin-left:4px;">DAYS</span></div>
            </div>
        </div>

        <div class="card c-meal" onclick="nav('p-meal')">
            <div class="bg-icon">ü•ó</div>
            <div class="card-content">
                <div class="streak-lbl">TODAY'S FUEL</div>
                <div class="c-meal-title" id="homeDayLabel">MEAL PLAN</div>
                <div style="font-size:0.8rem; font-weight:700; opacity:0.9; margin-top:6px;">Tap to View Details</div>
            </div>
            <div class="mc-prog">
                <svg viewBox="0 0 70 70">
                    <circle class="mc-bg" cx="35" cy="35" r="28" stroke-width="6" fill="none" />
                    <circle class="mc-fill" id="progCirc" cx="35" cy="35" r="28" stroke-width="6" fill="none" />
                </svg>
                <div class="mc-pct" id="calPct">0%</div>
            </div>
        </div>

        <div class="split">
            <div class="small-card c-water">
                <div class="bg-icon">üíß</div>
                <div class="card-content">
                    <div class="sc-lbl">HYDRATION</div>
                    <div class="sc-val"><span id="waterVal">0.0</span>L</div>
                    <div class="water-actions">
                        <button class="water-btn" onclick="event.stopPropagation(); modWater(0.3);">+300ml</button>
                        <button class="water-btn" onclick="event.stopPropagation(); modWater(0.5);">+500ml</button>
                    </div>
                </div>
            </div>
            <div class="small-card c-shop" onclick="nav('p-shop')">
                <div class="bg-icon">üìù</div>
                <div class="card-content">
                    <div class="sc-lbl">GROCERY</div>
                    <div class="sc-val">SHOPPING</div>
                    <div style="font-size:0.75rem; font-weight:700; opacity:0.8; margin-top:8px;">View List</div>
                </div>
            </div>
        </div>

        <div class="card c-maida" onclick="nav('p-maida')">
            <div class="bg-icon">üö´</div>
            <div class="card-content">
                <div class="streak-lbl">DISCIPLINE TRACKER</div>
                <div class="c-meal-title">NO MAIDA</div>
                <div style="font-size:0.8rem; font-weight:700; opacity:0.9; margin-top:6px;">
                    <span id="maidaStreakValHome">0</span> Days Clean
                </div>
            </div>
        </div>

        <div class="card c-history" onclick="nav('p-history')">
            <div class="bg-icon">üìÖ</div>
            <div class="card-content">
                <div class="streak-lbl">PAST PERFORMANCE</div>
                <div class="c-meal-title">HISTORY</div>
                <div style="font-size:0.8rem; font-weight:700; opacity:0.9; margin-top:6px;">View Daily Intake</div>
            </div>
        </div>
    </div>
</div>

<div id="p-meal" class="page">
    <div class="nav-back" onclick="nav('p-home')">‚Üê DASHBOARD</div>
    <div class="header" style="padding-top:0; align-items:flex-start;">
        <div>
            <div class="app-title">TODAY'S FUEL</div>
            <div id="dayLabel" style="font-size:1rem; opacity:0.8; color: var(--text-sec); font-weight:700;"></div>
        </div>
        
        <div class="toggle-wrapper" onclick="toggleTodayVeg()">
            <div class="switch-track" id="todayVegTrack">
                <div class="switch-thumb"></div>
            </div>
            <div class="toggle-label" id="todayVegLabel">NON-VEG</div>
        </div>
    </div>
    
    <div class="sticky-bar-container">
        <div class="sb-info">
            <span class="sb-title">Daily Intake</span>
            <span class="sb-val" id="mealPageCal">0 / 2200</span>
        </div>
        <div class="sb-track">
            <div class="sb-fill" id="sbFill"></div>
        </div>
    </div>

    <div id="mealContainer" class="meal-list"></div>
    <div style="padding:22px; font-weight:800; color:var(--text-sec); font-size:0.75rem; letter-spacing:1px; text-align:center;">CUSTOM LOGS</div>
    <div id="customList" class="meal-list"></div>
    <div style="padding:0 24px 20px 24px;">
        <button class="btn" style="background:var(--card-bg); color:var(--text); border:var(--card-border);" onclick="openModal('customModal')">+ ADD CUSTOM ITEM</button>
    </div>
</div>

<div id="p-shop" class="page">
    <div class="nav-back" onclick="nav('p-home')">‚Üê DASHBOARD</div>
    <div class="header" style="padding-top:0;"><div class="app-title">SHOPPING LIST <br><span style="font-size:1rem; opacity:0.8; color: var(--text-sec); font-weight:700;">TODAY'S INGREDIENTS</span></div></div>
    <div id="shopContainer" class="grid"></div>
</div>

<div id="p-maida" class="page">
    <div class="nav-back" onclick="nav('p-home')">‚Üê DASHBOARD</div>
    <div class="header" style="padding-top:0;"><div class="app-title">NO MAIDA CHALLENGE</div></div>
    <div class="grid">
        <div class="card" style="background:var(--card-bg); border:var(--card-border); text-align:center; padding:40px; color:var(--text);">
            <div style="font-size:5rem; margin-bottom:10px;">üçû</div>
            <div style="font-size:3.5rem; font-weight:900;" id="maidaStreakVal">0</div>
            <div class="streak-lbl">DAYS CLEAN</div>
            <button class="maida-btn" onclick="markMaida()">‚úÖ MARK TODAY SUCCESS</button>
        </div>
        <div id="maidaLog" style="margin-top:20px;"></div>
    </div>
</div>

<div id="p-history" class="page">
    <div class="nav-back" onclick="nav('p-home')">‚Üê DASHBOARD</div>
    <div class="header" style="padding-top:0;"><div class="app-title">HISTORY LOGS</div></div>
    <div id="historyContainer" class="grid"></div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-box">
        <h2>Settings</h2>
        <label style="font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:8px;">Daily Calorie Target</label>
        <input type="number" id="sTarg" value="2200">
        <button class="btn" onclick="saveSettings()">SAVE SETTINGS</button>
        
        <div style="margin-top:25px; border-top:1px solid rgba(128,128,128,0.2); padding-top:25px;">
            <h2 style="font-size:1rem; opacity:0.8;">1. Import Meal Plans</h2>
            <p style="font-size:0.75rem; color:var(--text-sec);">Paste a Weekly Object or a Daily Array Code:</p>
            <textarea id="importPlanArea" placeholder='{ "nonVeg": {...}, "veg": {...} } OR [...]'></textarea>
            <button class="btn" style="background:var(--input-bg); color:var(--text); border:1px solid var(--text-sec);" onclick="importPlanData()">IMPORT PLAN</button>
        </div>

        <div style="margin-top:25px; border-top:1px solid rgba(128,128,128,0.2); padding-top:25px; margin-bottom:15px;">
            <h2 style="font-size:1rem; opacity:0.8;">2. Import Food Database</h2>
            <p style="font-size:0.75rem; color:var(--text-sec);">Paste your massive array of foods to search from later:</p>
            <textarea id="importCustomArea" placeholder='[{"n": "Apple", "c": 95}, {"n": "Milk", "c": 120}]'></textarea>
            <button class="btn" style="background:var(--input-bg); color:var(--text); border:1px solid var(--text-sec);" onclick="importCustomData()">SAVE TO DATABASE</button>
        </div>

        <button class="btn btn-sec" style="color:#ff4444; border-color:#ff4444; margin-top:30px;" onclick="resetApp()">HARD RESET APP</button>
        <button class="btn btn-sec" onclick="closeModal('settingsModal')">CLOSE</button>
    </div>
</div>

<div id="customModal" class="modal">
    <div class="modal-box">
        <h2>Add Custom Entry</h2>
        <datalist id="foodDbList"></datalist>
        <input type="text" id="cName" placeholder="Search food database..." list="foodDbList" oninput="calcCustomCal()">
        <input type="number" id="cWeight" placeholder="Weight (grams/ml)" oninput="calcCustomCal()">
        <input type="number" id="cCal" placeholder="Total Calories">
        <button class="btn" onclick="addCustom()">ADD ENTRY</button>
        <button class="btn btn-sec" onclick="closeModal('customModal')">CANCEL</button>
    </div>
</div>

<script>
/* --- INIT EMPTY DATA --- */
const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
const currentDayName = daysOfWeek[new Date().getDay()];
let dailyPlan = [];
let weeklyPlan = {};
let weeklyPlanVeg = {};

// App State Object
let app = { 
    userName: "ATHARV", 
    target: 2200, 
    checks: {}, 
    water: 0, 
    custom: [], 
    streak: 0, 
    lastLog: "", 
    maidaDates: [], 
    theme: 'dark', 
    history: [],
    vegDate: "",     
    isVegToday: false,
    foodDB: []
};

function init() {
    // BUMPED TO v30 TO ENSURE ALL NEW CSS LOADS
    const saved = localStorage.getItem('fit_ultra_final_v30'); 
    if(saved) {
        const p = JSON.parse(saved);
        app = {...app, ...p.app};
        if(p.plan && typeof p.plan === 'object' && !Array.isArray(p.plan)) weeklyPlan = p.plan;
        if(p.planVeg && typeof p.planVeg === 'object' && !Array.isArray(p.planVeg)) weeklyPlanVeg = p.planVeg;
    }
    
    const today = new Date().toDateString();

    if(app.lastLog !== today) {
        if(app.lastLog) {
            let yesterCal = 0;
            let loggedDate = new Date(app.lastLog);
            let loggedDayName = daysOfWeek[loggedDate.getDay()];
            
            let yesterPlanList = (app.vegDate === app.lastLog && app.isVegToday) ? weeklyPlanVeg[loggedDayName] : weeklyPlan[loggedDayName];
            yesterPlanList = yesterPlanList || [];
            
            yesterPlanList.forEach((m, i) => { if(app.checks[i]) yesterCal += (m.calories || 0); });
            app.custom.forEach(c => yesterCal += c.c);
            
            if(yesterCal > 0 || app.water > 0) {
                if(!app.history) app.history = [];
                app.history.unshift({ date: app.lastLog, cals: yesterCal, water: app.water });
                if(app.history.length > 30) app.history.pop();
            }

            let yest = new Date(); yest.setDate(yest.getDate()-1);
            if(app.lastLog === yest.toDateString()) app.streak++;
            else app.streak = 0;
        }
        
        app.checks = {}; app.water = 0; app.custom = []; app.lastLog = today;
        app.isVegToday = false; 
        app.vegDate = today;
        
        save();
    }
    
    if(app.vegDate !== today) {
        app.isVegToday = false;
        app.vegDate = today;
        save();
    }
    
    dailyPlan = app.isVegToday ? (weeklyPlanVeg[currentDayName] || []) : (weeklyPlan[currentDayName] || []);
    
    if(app.theme === 'light') {
        document.body.classList.add('light-mode');
        document.getElementById('themeBtn').innerText = 'üåô';
    } else {
        document.body.classList.remove('light-mode');
        document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
    }

    document.getElementById('userName').innerText = app.userName + " ‚úé";
    document.getElementById('sTarg').value = app.target;
    document.getElementById('dayLabel').innerText = `${currentDayName.toUpperCase()}`;
    document.getElementById('homeDayLabel').innerText = `${currentDayName.toUpperCase()}'S PLAN`;
    
    updateTodayVegUI();
    renderFoodDB(); 
    render();
    setTimeout(scrollToNextMeal, 500);
}

function toggleTheme() {
    document.body.classList.toggle('light-mode');
    if(document.body.classList.contains('light-mode')) {
        app.theme = 'light';
        document.getElementById('themeBtn').innerText = 'üåô';
    } else {
        app.theme = 'dark';
        document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
    }
    save(); render();
}

function toggleTodayVeg() {
    app.isVegToday = !app.isVegToday;
    app.vegDate = new Date().toDateString();
    dailyPlan = app.isVegToday ? (weeklyPlanVeg[currentDayName] || []) : (weeklyPlan[currentDayName] || []);
    
    updateTodayVegUI();
    save();
    render();
    showToast(app.isVegToday ? "Switched to Veg Plan" : "Switched to Non-Veg Plan");
}

function updateTodayVegUI() {
    let track = document.getElementById('todayVegTrack');
    let label = document.getElementById('todayVegLabel');
    if(app.isVegToday) {
        track.classList.add('is-veg');
        label.innerText = "VEG";
        label.style.color = "#30D158";
    } else {
        track.classList.remove('is-veg');
        label.innerText = "NON-VEG";
        label.style.color = "var(--text)";
    }
}

function render() {
    const colors = ['#FF2D55', '#00F0FF', '#FF9F0A', '#BF5AF2', '#30D158', '#FF3B30']; 
    const now = new Date();
    const currentMins = now.getHours() * 60 + now.getMinutes();
    let nextIdx = -1;
    let totalCal = 0;
    
    // 1. RENDER PLANNED MEALS
    document.getElementById('mealContainer').innerHTML = dailyPlan.map((m, i) => {
        let isChk = app.checks[i];
        if(isChk) totalCal += (m.calories || m.c || 0);
        let color = colors[i % colors.length];
        
        let tVal = parseTime(m.time);
        if(nextIdx === -1 && tVal > currentMins && !isChk) nextIdx = i;
        let isNext = (i === nextIdx);
        
        let itemsHtml = (m.items || []).map(x => `
            <div class="ing-row">
                <div class="ing-left"><div class="ing-bullet"></div>${x.food}</div>
                <div class="ing-tag">${x.weight}</div>
            </div>`).join('');

        return `
        <div class="meal-card ${isChk?'checked':''} ${isNext?'highlight':''}" id="meal-${i}" style="--accent-color:${color}; --accent-rgb:${hexToRgb(color)}">
            <div class="next-badge">NEXT UP</div>
            <div class="check-box" onclick="togMeal(${i})">‚úì</div>
            <div class="mc-content" onclick="togMeal(${i})">
                <div class="mc-top">
                    <span class="mc-time" style="color:${color}">${m.time}</span>
                    <span class="mc-cal">${m.calories || 0} kcal</span>
                </div>
                <div class="mc-title">${m.n || getPhaseName(m.time)}</div>
                <div>${itemsHtml}</div>
            </div>
        </div>`;
    }).join('') || '<div style="text-align:center; padding: 30px; color: var(--text-sec);">No meals scheduled for today. Import your plan in settings.</div>';

    // 2. RENDER CUSTOM LOGS (NOW LOOKS LIKE A MEAL CARD)
    app.custom.forEach(c => totalCal += c.c);
    document.getElementById('customList').innerHTML = app.custom.map((c, i) => {
        // Continue the color cycle based on dailyPlan length
        let cCol = colors[(dailyPlan.length + i) % colors.length];
        
        // Extract Name and Weight beautifully
        let fName = c.n;
        let fWeight = "Logged";
        if(c.n.includes('(')) {
            let parts = c.n.split(/\(([^)]+)\)/); // splits text before and inside parentheses
            fName = parts[0].trim();
            if(parts[1]) fWeight = parts[1].trim();
        }

        let itemsHtml = `
            <div class="ing-row">
                <div class="ing-left"><div class="ing-bullet"></div>${fName}</div>
                <div class="ing-tag">${fWeight}</div>
            </div>`;

        return `
        <div class="meal-card" style="--accent-color:${cCol}; --accent-rgb:${hexToRgb(cCol)}">
            <div class="del-box" onclick="delCust(${i})">‚úï</div>
            <div class="mc-content">
                <div class="mc-top">
                    <span class="mc-time" style="color:${cCol}">EXTRA SNACK</span>
                    <span class="mc-cal">${c.c} kcal</span>
                </div>
                <div class="mc-title">Custom Log</div>
                <div>${itemsHtml}</div>
            </div>
        </div>`;
    }).join('') || '<div style="text-align:center; color:var(--text-sec); padding:20px;">No extra entries yet</div>';

    document.getElementById('dispStreak').innerText = app.streak;
    document.getElementById('waterVal').innerText = app.water.toFixed(1);
    document.getElementById('maidaStreakVal').innerText = app.maidaDates.length;
    document.getElementById('maidaStreakValHome').innerText = app.maidaDates.length;
    document.getElementById('maidaLog').innerHTML = app.maidaDates.map(d => `<div style="padding:15px; border-bottom:1px solid rgba(128,128,128,0.2); display:flex; justify-content:space-between; color:var(--text-sec);"><span>üìÖ ${d}</span><span style="color:#30D158">SUCCESS</span></div>`).join('') || '<div style="text-align:center; color:var(--text-sec); padding:20px;">No records yet</div>';

    let pct = Math.min(1, totalCal / app.target);
    document.getElementById('calPct').innerText = Math.round(pct * 100) + "%";
    document.getElementById('progCirc').style.strokeDashoffset = 175 - (175 * pct);
    
    document.getElementById('mealPageCal').innerText = `${totalCal} / ${app.target}`;
    document.getElementById('sbFill').style.width = (pct * 100) + "%";

    renderShop();
    renderHistory();
}

function renderShop() {
    let pantry = {};
    const block = ['water', 'walk', 'run', 'gym', 'workout'];
    dailyPlan.forEach(m => {
        if(m.items) m.items.forEach(i => {
            let n = i.food; let w = i.weight;
            if(!n) return;
            let clean = n.replace(/\(.*?\)/g, "").trim();
            if(block.some(b => clean.toLowerCase().includes(b))) return;
            if(!pantry[clean]) pantry[clean] = [];
            pantry[clean].push(w);
        });
    });
    document.getElementById('shopContainer').innerHTML = Object.keys(pantry).map(k => `
        <div class="shop-row" onclick="this.classList.toggle('done')">
            <span style="font-weight:700;">${k}</span>
            <span class="shop-qty">${pantry[k].join(" + ")}</span>
        </div>
    `).join('') || '<div style="text-align:center; color:var(--text-sec); padding:20px;">Shopping list is empty today</div>';
}

function renderHistory() {
    if(!app.history || app.history.length === 0) {
        document.getElementById('historyContainer').innerHTML = '<div style="text-align:center; color:var(--text-sec); padding:40px;">No history available yet.<br><small>Complete a day to see stats.</small></div>';
        return;
    }
    document.getElementById('historyContainer').innerHTML = app.history.map(h => {
        let dObj = new Date(h.date);
        let day = dObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        return `
        <div class="hist-row">
            <div class="hist-date">${day}</div>
            <div class="hist-data">
                <div class="hist-val">${h.cals} kcal</div>
                <div class="hist-sub">${h.water}L Water</div>
            </div>
        </div>`;
    }).join('');
}

function togMeal(i) {
    if(app.checks[i]) delete app.checks[i];
    else { app.checks[i] = true; confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#00E676', '#00C853', '#69F0AE'] }); }
    save(); render();
}

function importPlanData() {
    let input = document.getElementById('importPlanArea').value.trim();
    if(!input) { showToast("Please paste code first"); return; }
    try {
        let clean = input;
        if(clean.includes('=')) clean = clean.split('=').pop().trim();
        if(clean.endsWith(';')) clean = clean.slice(0, -1);
        let newData = new Function("return " + clean)();
        
        if(Array.isArray(newData)) {
            if(app.isVegToday) {
                if(!weeklyPlanVeg) weeklyPlanVeg = {};
                weeklyPlanVeg[currentDayName] = newData;
            } else {
                if(!weeklyPlan) weeklyPlan = {};
                weeklyPlan[currentDayName] = newData;
            }
            dailyPlan = newData;
            app.checks = {}; 
            save(); render(); closeModal('settingsModal');
            document.getElementById('importPlanArea').value = '';
            showToast("Today's Daily Plan Updated!");
        } else if(newData && newData.nonVeg && newData.veg) {
            weeklyPlan = newData.nonVeg;
            weeklyPlanVeg = newData.veg;
            dailyPlan = app.isVegToday ? (weeklyPlanVeg[currentDayName] || []) : (weeklyPlan[currentDayName] || []);
            app.checks = {}; 
            save(); render(); closeModal('settingsModal'); 
            document.getElementById('importPlanArea').value = '';
            showToast("Both Veg & Non-Veg Plans Updated!");
        } else if(typeof newData === 'object') {
            weeklyPlan = newData;
            weeklyPlanVeg = JSON.parse(JSON.stringify(newData)); 
            dailyPlan = app.isVegToday ? (weeklyPlanVeg[currentDayName] || []) : (weeklyPlan[currentDayName] || []);
            app.checks = {}; 
            save(); render(); closeModal('settingsModal'); 
            document.getElementById('importPlanArea').value = '';
            showToast("Plan Updated (Duplicated to Veg)!");
        } else { 
            showToast("Invalid format. Use an Array or Weekly Object."); 
        }
    } catch(e) { showToast("Error parsing plan code."); console.error(e); }
}

function importCustomData() {
    let input = document.getElementById('importCustomArea').value.trim();
    if(!input) { showToast("Please paste custom foods code first"); return; }
    try {
        let clean = input;
        if(clean.includes('=')) clean = clean.split('=').pop().trim();
        if(clean.endsWith(';')) clean = clean.slice(0, -1);
        let newData = new Function("return " + clean)();
        
        if(Array.isArray(newData)) {
            let valid = newData.filter(item => item.n && item.c);
            if(valid.length > 0) {
                app.foodDB = valid;
                save(); renderFoodDB(); closeModal('settingsModal');
                document.getElementById('importCustomArea').value = '';
                showToast(`${valid.length} Foods saved to Database!`);
            } else {
                showToast("No valid foods. Ensure format [{n: 'Name', c: 100}]");
            }
        } else {
            showToast("Data must be an Array.");
        }
    } catch(e) { showToast("Error parsing custom food code."); console.error(e); }
}

function renderFoodDB() {
    let dl = document.getElementById('foodDbList');
    if(dl && app.foodDB) {
        dl.innerHTML = app.foodDB.map(f => `<option value="${f.n}">`).join('');
    }
}

function calcCustomCal() {
    let n = document.getElementById('cName').value;
    let w = parseFloat(document.getElementById('cWeight').value);
    let calInput = document.getElementById('cCal');
    
    let match = (app.foodDB || []).find(x => x.n === n);
    
    if (match) {
        if (!isNaN(w) && w > 0) {
            calInput.value = Math.round((match.c / 100) * w);
        } else {
            calInput.value = match.c; 
        }
    }
}

function scrollToNextMeal() {
    let el = document.querySelector('.meal-card.highlight');
    if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function nav(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
    
    if(id === 'p-meal') setTimeout(scrollToNextMeal, 300);
}

function markMaida() {
    let d = new Date().toISOString().split('T')[0];
    if(!app.maidaDates.includes(d)) {
        app.maidaDates.push(d); app.maidaDates.sort().reverse();
        save(); render(); showToast("Maida Streak +1"); 
        confetti({ particleCount: 150, spread: 80, colors: ['#2979FF', '#448AFF', '#82B1FF'] });
    } else { showToast("Already logged today!"); }
}

function modWater(n) { app.water = parseFloat((app.water + n).toFixed(2)); save(); render(); showToast(`+${n*1000}ml Water üíß`); }

function addCustom() { 
    let n = document.getElementById('cName').value.trim(); 
    let w = document.getElementById('cWeight').value.trim();
    let c = parseInt(document.getElementById('cCal').value); 
    
    if(n && c) { 
        let finalName = n;
        if(w && !isNaN(w)) {
            finalName = n.replace(/\s*\(\s*100g\s*\)/i, '') + ` (${w}g)`;
        } else if (w) {
            finalName = n.replace(/\s*\(\s*100g\s*\)/i, '') + ` (${w})`;
        }
        
        app.custom.push({n: finalName, c: c}); 
        save(); render(); closeModal('customModal'); 
        showToast("Entry Added to Today's Log!"); 
        document.getElementById('cName').value = ''; 
        document.getElementById('cWeight').value = ''; 
        document.getElementById('cCal').value = ''; 
    } else { 
        showToast("Fill Food Name and Calories!"); 
    } 
}

function delCust(i) { app.custom.splice(i,1); save(); render(); showToast("Entry Removed"); }
function editName() { let n = prompt("Enter your name:", app.userName); if(n && n.trim()) { app.userName = n.trim(); save(); init(); } }

function parseTime(val) { 
    if(!val) return 0; 
    let clean = val.toLowerCase().replace(/\s+/g, ''); 
    let isPM = clean.includes('pm'); 
    let isAM = clean.includes('am'); 
    let timeMatch = clean.match(/(\d+):(\d+)/);
    if(!timeMatch) return 0;
    let h = parseInt(timeMatch[1]);
    let m = parseInt(timeMatch[2]);
    if(isPM && h !== 12) h += 12; 
    if(isAM && h === 12) h = 0; 
    return h * 60 + m; 
}

function hexToRgb(hex) { var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '255,255,255'; }
function getPhaseName(t) { let val = parseTime(t); if(val < 360) return "Pre-Workout"; if(val < 600) return "Breakfast"; if(val < 720) return "Morning Snack"; if(val < 900) return "Lunch"; if(val < 1080) return "Evening Snack"; return "Dinner"; }
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function save() { localStorage.setItem('fit_ultra_final_v30', JSON.stringify({app, plan: weeklyPlan, planVeg: weeklyPlanVeg})); }
function saveSettings() { app.target = parseInt(document.getElementById('sTarg').value); save(); render(); closeModal('settingsModal'); showToast("Settings Saved!"); }

function resetApp() { 
    if(confirm("HARD RESET: Are you sure you want to delete ALL local storage data for this app and start over?")) { 
        localStorage.clear(); 
        location.reload(); 
    } 
}

function showToast(m) { let t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }

init();
</script>
</body>
</html>