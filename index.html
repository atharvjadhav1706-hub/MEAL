<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pro FitHub</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
:root {
  --bg: #060608;
  --bg2: #0a0a0f;
  --surface: rgba(255,255,255,0.03);
  --surface-hover: rgba(255,255,255,0.06);
  --border: rgba(255,255,255,0.07);
  --border-bright: rgba(255,255,255,0.14);
  --text: #f0f0f8;
  --text-sec: rgba(240,240,248,0.45);
  --text-muted: rgba(240,240,248,0.25);

  /* Accent palette */
  --a-orange: #FF5C2E;
  --a-green: #00E5A0;
  --a-blue: #4D9EFF;
  --a-purple: #C77DFF;
  --a-cyan: #00D4FF;
  --a-gold: #FFD166;
  --a-red: #FF4D6D;

  --font-display: 'Syne', sans-serif;
  --font-body: 'DM Sans', sans-serif;
  --radius: 24px;
  --radius-sm: 14px;

  --glow-orange: 0 0 40px rgba(255,92,46,0.25);
  --glow-green: 0 0 40px rgba(0,229,160,0.25);
  --glow-blue: 0 0 40px rgba(77,158,255,0.25);

  --noise: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
}

body.light-mode {
  --bg: #F2F3F8;
  --bg2: #E8EAF2;
  --surface: rgba(255,255,255,0.85);
  --surface-hover: rgba(255,255,255,1);
  --border: rgba(0,0,0,0.07);
  --border-bright: rgba(0,0,0,0.12);
  --text: #0D0D14;
  --text-sec: rgba(13,13,20,0.55);
  --text-muted: rgba(13,13,20,0.3);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; margin: 0; padding: 0; }

html { scroll-behavior: smooth; }

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  overflow-x: hidden;
  padding-bottom: 60px;
  transition: background 0.4s ease, color 0.4s ease;
  min-height: 100vh;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: 
    radial-gradient(ellipse 800px 600px at 80% -10%, rgba(77,158,255,0.07) 0%, transparent 60%),
    radial-gradient(ellipse 600px 500px at -10% 60%, rgba(199,125,255,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 500px 400px at 90% 90%, rgba(0,229,160,0.05) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}

body.light-mode::before { display: none; }

/* ANIMATIONS */
@keyframes slideUp { from { transform: translateY(28px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes float { 0%,100% { transform: translateY(0) rotate(0deg) scale(1); } 50% { transform: translateY(-10px) rotate(4deg) scale(1.05); } }
@keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
@keyframes barFlow { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
@keyframes pulseRing { 0%,100% { box-shadow: 0 0 0 0 rgba(255,255,255,0.2); } 50% { box-shadow: 0 0 0 6px rgba(255,255,255,0); } }
@keyframes fadeInStagger { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes dotPulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.7); } }

/* LAYOUT */
.page { display: none; position: relative; z-index: 1; animation: slideUp 0.45s cubic-bezier(0.16, 1, 0.3, 1); }
.page.active { display: block; }
.grid { padding: 0 20px; display: flex; flex-direction: column; gap: 14px; }

/* HEADER */
.header {
  padding: 52px 24px 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.welcome-sub {
  font-family: var(--font-body);
  font-size: 0.65rem;
  font-weight: 500;
  color: var(--text-sec);
  letter-spacing: 2.5px;
  text-transform: uppercase;
  margin-bottom: 4px;
}

.app-title {
  font-family: var(--font-display);
  font-size: 1.75rem;
  font-weight: 800;
  letter-spacing: -0.5px;
  color: var(--text);
  line-height: 1;
  overflow-wrap: break-word;
}

.head-actions { display: flex; gap: 10px; flex-shrink: 0; padding-top: 4px; }

.icon-btn {
  width: 42px; height: 42px;
  border-radius: 50%;
  background: var(--surface);
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  backdrop-filter: blur(10px);
  color: var(--text);
}
.icon-btn:active { transform: scale(0.88); }
.icon-btn:hover { background: var(--surface-hover); border-color: var(--border-bright); }

/* CARDS */
.card {
  border-radius: var(--radius);
  padding: 24px;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  border: 1px solid var(--border);
  backdrop-filter: blur(20px);
  transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.25s ease;
}
.card:active { transform: scale(0.975); }
.card:hover { border-color: var(--border-bright); }

.card::after {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--noise);
  opacity: 0.4;
  pointer-events: none;
  mix-blend-mode: overlay;
}

.bg-icon {
  position: absolute;
  right: 18px; top: 50%;
  margin-top: -28px;
  font-size: 4rem;
  opacity: 0.18;
  z-index: 0;
  filter: saturate(0.6);
  pointer-events: none;
  animation: float 6s ease-in-out infinite;
}
.card-content { position: relative; z-index: 2; }

/* STREAK CARD */
.c-streak {
  background: linear-gradient(135deg, rgba(255,92,46,0.15) 0%, rgba(255,92,46,0.04) 60%, transparent 100%);
  border-color: rgba(255,92,46,0.2);
}
body:not(.light-mode) .c-streak { box-shadow: var(--glow-orange); }
body.light-mode .c-streak { background: linear-gradient(135deg, #FF5C2E 0%, #ff3300 100%); border: none; }

.c-meal {
  background: linear-gradient(135deg, rgba(0,229,160,0.12) 0%, rgba(0,229,160,0.03) 60%, transparent 100%);
  border-color: rgba(0,229,160,0.2);
}
body:not(.light-mode) .c-meal { box-shadow: var(--glow-green); }
body.light-mode .c-meal { background: linear-gradient(135deg, #00b377 0%, #008a5c 100%); border: none; }

.c-maida {
  background: linear-gradient(135deg, rgba(77,158,255,0.12) 0%, rgba(77,158,255,0.03) 60%, transparent 100%);
  border-color: rgba(77,158,255,0.2);
}
body:not(.light-mode) .c-maida { box-shadow: var(--glow-blue); }
body.light-mode .c-maida { background: linear-gradient(135deg, #2979FF 0%, #1a5cc4 100%); border: none; }

.c-history {
  background: linear-gradient(135deg, rgba(255,209,102,0.12) 0%, rgba(255,209,102,0.03) 60%, transparent 100%);
  border-color: rgba(255,209,102,0.2);
}
body.light-mode .c-history { background: linear-gradient(135deg, #f5a623 0%, #c47f00 100%); border: none; }

body.light-mode .card { color: #fff !important; }
body.light-mode .card .streak-lbl { color: rgba(255,255,255,0.7) !important; }
body.light-mode .card .streak-val { color: #fff !important; }
body.light-mode .card .c-meal-title { color: #fff !important; }

/* STREAK */
.streak-lbl {
  font-family: var(--font-body);
  font-size: 0.62rem;
  font-weight: 600;
  color: var(--text-sec);
  letter-spacing: 2px;
  text-transform: uppercase;
}
.streak-val {
  font-family: var(--font-display);
  font-size: 3.2rem;
  font-weight: 800;
  line-height: 1;
  display: flex; align-items: baseline; gap: 8px;
  margin-top: 8px;
  letter-spacing: -2px;
}
.streak-unit {
  font-size: 1rem;
  font-weight: 600;
  letter-spacing: 0;
  opacity: 0.7;
  color: var(--a-orange);
}
body.light-mode .streak-unit { color: rgba(255,255,255,0.8); }

/* MEAL CARD */
.c-meal-title {
  font-family: var(--font-display);
  font-size: 1.6rem;
  font-weight: 800;
  line-height: 1.1;
  margin-top: 8px;
  letter-spacing: -0.5px;
  max-width: calc(100% - 100px);
  overflow-wrap: break-word;
}

.c-meal-sub {
  font-size: 0.78rem;
  font-weight: 500;
  opacity: 0.65;
  margin-top: 8px;
  letter-spacing: 0.3px;
}

/* CIRCULAR PROGRESS */
.mc-prog {
  position: absolute;
  right: 18px; top: 50%; transform: translateY(-50%);
  width: 84px; height: 84px;
  display: flex; align-items: center; justify-content: center;
  z-index: 2;
}
.mc-prog svg { width: 100%; height: 100%; transform: rotate(-90deg); }
.mc-bg { stroke: rgba(255,255,255,0.1); }
.mc-fill { stroke: rgba(255,255,255,0.9); stroke-dasharray: 175; stroke-dashoffset: 175; transition: stroke-dashoffset 1.2s cubic-bezier(0.16, 1, 0.3, 1); stroke-linecap: round; filter: drop-shadow(0 0 4px rgba(255,255,255,0.4)); }
.mc-pct { font-family: var(--font-display); font-size: 0.85rem; font-weight: 800; position: absolute; color: #fff; }

/* SPLIT GRID */
.split { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

.small-card {
  min-height: 160px;
  border-radius: var(--radius);
  padding: 22px 18px;
  display: flex; flex-direction: column; justify-content: space-between;
  position: relative; overflow: hidden;
  border: 1px solid var(--border);
  background: var(--surface);
  backdrop-filter: blur(20px);
  cursor: pointer;
  transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.small-card:active { transform: scale(0.96); }
.small-card::after { content: ''; position: absolute; inset: 0; background: var(--noise); opacity: 0.3; pointer-events: none; mix-blend-mode: overlay; }
.small-card .bg-icon { font-size: 3rem; right: -5px; bottom: 8px; top: auto; margin-top: 0; opacity: 0.15; }

.small-card.c-water {
  background: linear-gradient(145deg, rgba(0,212,255,0.15) 0%, rgba(0,212,255,0.04) 100%);
  border-color: rgba(0,212,255,0.2);
}
body:not(.light-mode) .small-card.c-water { box-shadow: 0 0 30px rgba(0,212,255,0.12); }
body.light-mode .small-card.c-water { background: linear-gradient(145deg, #00b0cc, #007a99); border: none; }

.small-card.c-shop {
  background: linear-gradient(145deg, rgba(199,125,255,0.15) 0%, rgba(199,125,255,0.04) 100%);
  border-color: rgba(199,125,255,0.2);
}
body:not(.light-mode) .small-card.c-shop { box-shadow: 0 0 30px rgba(199,125,255,0.12); }
body.light-mode .small-card.c-shop { background: linear-gradient(145deg, #9b59b6, #6c3483); border: none; }

body.light-mode .small-card { color: #fff !important; }

.sc-label-row { position: relative; z-index: 2; }
.sc-lbl { font-size: 0.6rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; opacity: 0.65; }
.sc-val {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 800;
  letter-spacing: -1px;
  margin-top: 4px;
}
.sc-sub { font-size: 0.7rem; font-weight: 500; opacity: 0.6; margin-top: 4px; }

/* WATER BUTTONS */
.water-actions { display: flex; gap: 6px; position: relative; z-index: 2; }
.water-btn {
  flex: 1;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.2);
  color: inherit;
  padding: 9px 6px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 0.72rem;
  cursor: pointer;
  transition: all 0.2s;
  backdrop-filter: blur(4px);
  font-family: var(--font-body);
  white-space: nowrap;
}
.water-btn:active { transform: scale(0.93); background: rgba(255,255,255,0.3); }

/* MEAL PAGE */
.nav-back {
  margin: 20px 20px 10px 20px;
  display: inline-flex; align-items: center; gap: 8px;
  background: var(--surface);
  padding: 10px 20px;
  border-radius: 40px;
  font-family: var(--font-display);
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 1px;
  color: var(--text-sec);
  cursor: pointer;
  border: 1px solid var(--border);
  transition: all 0.2s;
}
.nav-back:hover { color: var(--text); border-color: var(--border-bright); }
.nav-back:active { transform: scale(0.96); }

/* STICKY BAR */
.sticky-bar-container {
  position: sticky; top: 0; z-index: 100;
  background: rgba(6,6,8,0.88);
  backdrop-filter: blur(20px) saturate(1.5);
  padding: 14px 20px 16px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 16px;
}
body.light-mode .sticky-bar-container { background: rgba(242,243,248,0.92); }

.sb-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.sb-title { font-size: 0.65rem; font-weight: 600; color: var(--text-sec); letter-spacing: 1.5px; text-transform: uppercase; }
.sb-val { font-family: var(--font-display); font-size: 1rem; font-weight: 800; color: var(--text); }
.sb-track { width: 100%; height: 6px; background: rgba(128,128,128,0.15); border-radius: 10px; overflow: visible; position: relative; }
.sb-fill {
  height: 100%;
  width: 0%;
  border-radius: 10px;
  background: linear-gradient(90deg, #FF4D6D, #FF5C2E, #FFD166, #00E5A0, #4D9EFF, #C77DFF);
  background-size: 300% 100%;
  animation: barFlow 3s linear infinite;
  transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  box-shadow: 0 0 12px rgba(255,255,255,0.25);
  position: relative;
}
.sb-fill::after {
  content: '';
  position: absolute;
  right: -1px; top: 50%;
  transform: translateY(-50%);
  width: 10px; height: 10px;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 0 8px rgba(255,255,255,0.6);
  transition: opacity 0.3s;
}

/* MEAL LIST */
.meal-list { padding: 0 20px; }

.meal-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  margin-bottom: 14px;
  position: relative;
  overflow: hidden;
  padding-left: 4px;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}
.meal-card::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0;
  width: 4px;
  background: var(--accent-color, #fff);
  border-radius: 4px 0 0 4px;
}
.meal-card:hover { border-color: var(--border-bright); transform: translateY(-1px); }

.meal-card.highlight {
  border: 1px solid var(--accent-color) !important;
  box-shadow: 0 0 0 1px var(--accent-color), 0 8px 32px rgba(var(--accent-rgb),0.15) !important;
  animation: pulseRing 2.5s ease-in-out infinite;
}
.meal-card.highlight .next-badge { display: block; }

.next-badge {
  display: none;
  position: absolute; top: 0; right: 50px;
  background: var(--accent-color);
  color: #000;
  font-size: 0.55rem;
  font-weight: 900;
  padding: 5px 12px;
  border-bottom-left-radius: 10px;
  border-bottom-right-radius: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  z-index: 10;
  font-family: var(--font-display);
}

.mc-content { padding: 18px; cursor: pointer; }
.mc-top { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; padding-right: 44px; }
.mc-time { color: var(--accent-color); font-weight: 700; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 1px; flex-shrink: 0; }
.mc-cal {
  background: rgba(128,128,128,0.08);
  color: var(--text-sec);
  padding: 4px 10px; border-radius: 8px;
  font-weight: 600; font-size: 0.7rem;
  border: 1px solid var(--border);
  flex-shrink: 0;
}
.mc-title {
  font-family: var(--font-display);
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 14px;
  letter-spacing: -0.3px;
  line-height: 1.3;
  padding-right: 44px;
  overflow-wrap: break-word;
}

.ing-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border); gap: 10px; }
.ing-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.ing-left { display: flex; align-items: center; color: var(--text-sec); font-weight: 500; font-size: 0.9rem; flex: 1; min-width: 0; overflow: hidden; }
.ing-bullet { width: 5px; height: 5px; border-radius: 50%; background: var(--accent-color); margin-right: 10px; flex-shrink: 0; opacity: 0.7; }
.ing-left-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; flex: 1; }
.ing-tag { background: var(--surface); color: var(--text); font-weight: 600; font-size: 0.75rem; padding: 4px 10px; border-radius: 8px; min-width: 56px; text-align: center; border: 1px solid var(--border); flex-shrink: 0; }

.check-box {
  position: absolute; top: 16px; right: 16px;
  width: 34px; height: 34px;
  border: 1.5px solid var(--border-bright);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  background: var(--surface);
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  font-size: 1rem; color: transparent;
  z-index: 10; flex-shrink: 0;
}
.check-box:active { transform: scale(0.85); }
.meal-card.checked { opacity: 0.4; filter: grayscale(0.8); }
.meal-card.checked .check-box { background: var(--a-green); border-color: var(--a-green); color: #000; box-shadow: 0 0 16px rgba(0,229,160,0.4); }

/* TOGGLE */
.toggle-wrapper {
  display: flex; align-items: center; gap: 8px;
  background: var(--surface); border: 1px solid var(--border);
  padding: 8px 14px; border-radius: 40px;
  cursor: pointer;
  transition: all 0.2s;
}
.switch-track { width: 42px; height: 22px; background: rgba(255,77,109,0.6); border-radius: 11px; position: relative; transition: 0.3s; }
.switch-track.is-veg { background: rgba(0,229,160,0.7); }
.switch-thumb { width: 18px; height: 18px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s cubic-bezier(0.34,1.56,0.64,1); box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
.switch-track.is-veg .switch-thumb { transform: translateX(20px); }
.toggle-label { font-size: 0.65rem; font-weight: 700; letter-spacing: 1.5px; color: var(--text-sec); text-transform: uppercase; width: 60px; text-align: center; font-family: var(--font-body); }

/* SHOP ROWS */
.shop-row, .hist-row {
  background: var(--surface);
  padding: 16px 18px;
  border-radius: 14px;
  margin-bottom: 10px;
  border: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
  cursor: pointer;
  transition: all 0.2s;
  gap: 12px;
  color: var(--text);
}
.shop-row:hover { border-color: var(--border-bright); transform: translateX(2px); }
.shop-row.done { opacity: 0.25; text-decoration: line-through; }
.shop-name { flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; font-size: 0.95rem; }
.shop-qty { background: rgba(0,229,160,0.1); padding: 5px 12px; border-radius: 8px; font-weight: 700; color: var(--a-green); font-size: 0.82rem; flex-shrink: 0; border: 1px solid rgba(0,229,160,0.2); }

.hist-row { cursor: default; }
.hist-row:hover { transform: none; }
.hist-date { font-weight: 600; color: var(--text-sec); font-size: 0.9rem; flex: 1; }
.hist-data { text-align: right; flex-shrink: 0; }
.hist-val { font-family: var(--font-display); font-weight: 800; font-size: 1rem; color: var(--text); }
.hist-sub { font-size: 0.72rem; color: var(--text-sec); font-weight: 500; margin-top: 2px; }

/* MAIDA */
.maida-hero {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 40px 20px;
  text-align: center;
}
.maida-num {
  font-family: var(--font-display);
  font-size: 5rem;
  font-weight: 800;
  letter-spacing: -4px;
  background: linear-gradient(135deg, var(--a-blue), var(--a-purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1;
  margin: 12px 0 4px;
}
.maida-lbl {
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-sec);
}
.maida-icon { font-size: 3.5rem; margin-bottom: 8px; display: block; animation: float 4s ease-in-out infinite; }
.maida-btn {
  width: 100%;
  padding: 20px;
  margin-top: 28px;
  background: linear-gradient(135deg, var(--a-blue), var(--a-purple));
  color: #fff;
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 0.9rem;
  letter-spacing: 1px;
  border: none;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 8px 24px rgba(77,158,255,0.3);
}
.maida-btn:active { transform: scale(0.97); opacity: 0.9; }

/* MODAL */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(12px); z-index: 2000; align-items: flex-end; justify-content: center; }
.modal.active { display: flex; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

.modal-box {
  background: var(--bg2);
  padding: 30px;
  width: 100%;
  max-width: 500px;
  max-height: 92vh;
  overflow-y: auto;
  border-radius: 28px 28px 0 0;
  border: 1px solid var(--border);
  border-bottom: none;
  color: var(--text);
}
body.light-mode .modal-box { background: #fff; }

.modal-handle { width: 40px; height: 4px; background: var(--border-bright); border-radius: 4px; margin: 0 auto 24px; }

h2 { font-family: var(--font-display); font-size: 1.4rem; font-weight: 800; margin-bottom: 20px; letter-spacing: -0.3px; color: var(--text); }
h3 { font-family: var(--font-display); font-size: 0.9rem; font-weight: 700; color: var(--text-sec); margin-bottom: 10px; letter-spacing: 0.5px; }

input, textarea {
  width: 100%;
  padding: 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 14px;
  margin-bottom: 12px;
  font-family: var(--font-body);
  font-size: 0.95rem;
  transition: border-color 0.2s;
}
input:focus, textarea:focus { border-color: var(--border-bright); }
textarea { height: 90px; font-family: monospace; font-size: 0.78rem; color: var(--a-green); resize: none; }

.btn {
  width: 100%;
  padding: 17px;
  background: var(--text);
  color: var(--bg);
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 0.9rem;
  letter-spacing: 0.5px;
  border: none;
  border-radius: 16px;
  cursor: pointer;
  margin-top: 6px;
  transition: all 0.2s;
}
.btn:active { opacity: 0.85; transform: scale(0.99); }
.btn-sec { background: transparent; border: 1px solid var(--border); color: var(--text-sec); font-size: 0.85rem; }
.btn-sec:hover { border-color: var(--border-bright); color: var(--text); }

.btn-danger { background: rgba(255,77,109,0.12); color: var(--a-red); border: 1px solid rgba(255,77,109,0.2); margin-top: 30px; }

.section-divider { border: none; border-top: 1px solid var(--border); margin: 24px 0; }

/* TOAST */
.toast {
  position: fixed; top: 20px; left: 50%;
  transform: translateX(-50%) translateY(-4px);
  background: rgba(20,20,25,0.95);
  color: var(--text);
  padding: 12px 22px;
  border-radius: 40px;
  z-index: 3000;
  border: 1px solid var(--border-bright);
  opacity: 0;
  transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
  pointer-events: none;
  font-weight: 600;
  font-size: 0.88rem;
  display: flex; gap: 8px; align-items: center;
  box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  backdrop-filter: blur(16px);
  white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); top: 50px; }
body.light-mode .toast { background: rgba(255,255,255,0.95); color: #000; border-color: rgba(0,0,0,0.1); }

/* AUTOCOMPLETE */
.search-wrapper { position: relative; }
.autocomplete-list {
  position: absolute; top: calc(100% + 4px); left: 0; right: 0;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 16px;
  max-height: 220px; overflow-y: auto;
  z-index: 200;
  box-shadow: 0 16px 40px rgba(0,0,0,0.4);
  display: none; padding: 8px;
}
.autocomplete-list.show { display: block; animation: slideUp 0.2s ease; }
.autocomplete-item { padding: 11px 14px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 10px; transition: 0.15s; gap: 10px; }
.autocomplete-item:last-child { border-bottom: none; }
.autocomplete-item:hover { background: var(--surface-hover); }
.autocomplete-item strong { font-size: 0.9rem; color: var(--text); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; }
.autocomplete-item span { font-size: 0.75rem; color: var(--text-sec); font-weight: 600; background: var(--surface); padding: 4px 8px; border-radius: 6px; flex-shrink: 0; }

/* PAGE HEADERS */
.page-header { padding: 10px 24px 16px; }
.page-title { font-family: var(--font-display); font-size: 2rem; font-weight: 800; letter-spacing: -0.8px; line-height: 1; }
.page-sub { font-size: 0.8rem; color: var(--text-sec); font-weight: 500; margin-top: 5px; }

/* SECTION LABEL */
.section-label { padding: 4px 20px 14px; font-size: 0.6rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); }

/* STAGGERED ANIMATION */
.card:nth-child(1) { animation: fadeInStagger 0.5s ease both 0.05s; }
.card:nth-child(2) { animation: fadeInStagger 0.5s ease both 0.12s; }
.split { animation: fadeInStagger 0.5s ease both 0.2s; }
.card:nth-child(4) { animation: fadeInStagger 0.5s ease both 0.28s; }
.card:nth-child(5) { animation: fadeInStagger 0.5s ease both 0.36s; }

/* LIVE INDICATOR */
.live-dot {
  display: inline-block; width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--a-green);
  margin-right: 6px;
  vertical-align: middle;
  animation: dotPulse 1.8s ease-in-out infinite;
  box-shadow: 0 0 6px var(--a-green);
}

/* MAIDA LOG */
.maida-log-item {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
}
.maida-log-item:last-child { border-bottom: none; }

/* CUSTOM ADD BTN */
.add-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 16px;
  background: var(--surface);
  border: 1px dashed var(--border-bright);
  border-radius: 16px;
  cursor: pointer;
  color: var(--text-sec);
  font-weight: 600;
  font-size: 0.88rem;
  transition: all 0.2s;
  width: 100%;
  font-family: var(--font-body);
}
.add-btn:hover { border-color: var(--text-sec); color: var(--text); background: var(--surface-hover); }
.add-btn:active { transform: scale(0.98); }

/* GRADIENT TEXT */
.grad-text-orange { background: linear-gradient(135deg, #FF5C2E, #FFD166); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.grad-text-green { background: linear-gradient(135deg, #00E5A0, #4D9EFF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
body.light-mode .grad-text-orange, body.light-mode .grad-text-green { -webkit-text-fill-color: #fff; }

/* RESPONSIVE */
@media (max-width: 360px) {
  .streak-val { font-size: 2.6rem; }
  .c-meal-title { font-size: 1.3rem; }
}
</style>
</head>
<body>

<div class="toast" id="toast"><span id="toastEmoji">‚úì</span> <span id="toastMsg">Saved</span></div>

<!-- HOME PAGE -->
<div id="p-home" class="page active">
  <div class="header">
    <div onclick="editName()" style="cursor:pointer; flex:1; min-width:0;">
      <div class="welcome-sub">Good day,</div>
      <div class="app-title" id="userName">ATHARV</div>
    </div>
    <div class="head-actions">
      <div class="icon-btn" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è</div>
      <div class="icon-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</div>
    </div>
  </div>

  <div class="grid">
    <!-- STREAK CARD -->
    <div class="card c-streak">
      <div class="bg-icon">üèÜ</div>
      <div class="card-content">
        <div class="streak-lbl">Active Streak</div>
        <div class="streak-val">
          <span id="dispStreak" class="grad-text-orange">0</span>
          <span class="streak-unit">DAYS</span>
        </div>
        <div style="font-size:0.75rem; color:var(--text-sec); margin-top:10px; font-weight:500;">Keep going ‚Äî consistency is key</div>
      </div>
    </div>

    <!-- MEAL CARD -->
    <div class="card c-meal" onclick="nav('p-meal')">
      <div class="bg-icon">ü•ó</div>
      <div class="card-content">
        <div class="streak-lbl"><span class="live-dot"></span>Today's Fuel</div>
        <div class="c-meal-title" id="homeDayLabel">MEAL PLAN</div>
        <div class="c-meal-sub">Tap to track your meals ‚Üí</div>
      </div>
      <div class="mc-prog">
        <svg viewBox="0 0 70 70">
          <circle class="mc-bg" cx="35" cy="35" r="28" stroke-width="5" fill="none"/>
          <circle class="mc-fill" id="progCirc" cx="35" cy="35" r="28" stroke-width="5" fill="none"/>
        </svg>
        <div class="mc-pct" id="calPct">0%</div>
      </div>
    </div>

    <!-- WATER + SHOP -->
    <div class="split">
      <div class="small-card c-water">
        <div class="bg-icon">üíß</div>
        <div class="sc-label-row">
          <div class="sc-lbl">Hydration</div>
          <div class="sc-val"><span id="waterVal">0.0</span><span style="font-size:1rem; opacity:0.7;">L</span></div>
        </div>
        <div class="water-actions">
          <button class="water-btn" onclick="event.stopPropagation(); modWater(0.3);">+300ml</button>
          <button class="water-btn" onclick="event.stopPropagation(); modWater(0.5);">+500ml</button>
        </div>
      </div>
      <div class="small-card c-shop" onclick="nav('p-shop')">
        <div class="bg-icon">üõí</div>
        <div class="sc-label-row">
          <div class="sc-lbl">Grocery</div>
          <div class="sc-val">LIST</div>
        </div>
        <div class="sc-sub">View ‚Üí</div>
      </div>
    </div>

    <!-- MAIDA CARD -->
    <div class="card c-maida" onclick="nav('p-maida')">
      <div class="bg-icon">üö´</div>
      <div class="card-content">
        <div class="streak-lbl">Discipline Tracker</div>
        <div class="c-meal-title" style="font-size:1.5rem;">NO MAIDA</div>
        <div class="c-meal-sub"><span id="maidaStreakValHome" class="grad-text-green">0</span> Days Clean</div>
      </div>
    </div>

    <!-- HISTORY CARD -->
    <div class="card c-history" onclick="nav('p-history')">
      <div class="bg-icon">üìä</div>
      <div class="card-content">
        <div class="streak-lbl">Past Performance</div>
        <div class="c-meal-title" style="font-size:1.5rem;">HISTORY</div>
        <div class="c-meal-sub">View daily intake logs ‚Üí</div>
      </div>
    </div>
  </div>
</div>

<!-- MEAL PAGE -->
<div id="p-meal" class="page">
  <div class="nav-back" onclick="nav('p-home')">‚Üê Dashboard</div>
  <div class="header" style="padding-top:8px; align-items:flex-start;">
    <div>
      <div class="page-title">TODAY'S FUEL</div>
      <div class="page-sub" id="dayLabel"></div>
    </div>
    <div class="toggle-wrapper" onclick="toggleTodayVeg()">
      <div class="switch-track" id="todayVegTrack"><div class="switch-thumb"></div></div>
      <div class="toggle-label" id="todayVegLabel">NON-VEG</div>
    </div>
  </div>

  <div class="sticky-bar-container">
    <div class="sb-info">
      <span class="sb-title">Daily Intake</span>
      <span class="sb-val" id="mealPageCal">0 / 2200</span>
    </div>
    <div class="sb-track"><div class="sb-fill" id="sbFill"></div></div>
  </div>

  <div id="mealContainer" class="meal-list"></div>
  <div class="section-label">Custom Logs</div>
  <div id="customList" class="meal-list"></div>
  <div style="padding: 0 20px 24px;">
    <button class="add-btn" onclick="openModal('customModal')">
      <span style="font-size:1.1rem;">+</span> Add Custom Entry
    </button>
  </div>
</div>

<!-- SHOP PAGE -->
<div id="p-shop" class="page">
  <div class="nav-back" onclick="nav('p-home')">‚Üê Dashboard</div>
  <div class="header" style="padding-top:8px;">
    <div>
      <div class="page-title">SHOPPING</div>
      <div class="page-sub">Today's ingredients</div>
    </div>
  </div>
  <div id="shopContainer" style="padding: 0 20px;"></div>
</div>

<!-- MAIDA PAGE -->
<div id="p-maida" class="page">
  <div class="nav-back" onclick="nav('p-home')">‚Üê Dashboard</div>
  <div class="header" style="padding-top:8px;">
    <div class="page-title">NO MAIDA</div>
  </div>
  <div class="grid">
    <div class="maida-hero">
      <span class="maida-icon">üçû</span>
      <div class="maida-lbl">Days Clean</div>
      <div class="maida-num" id="maidaStreakVal">0</div>
      <button class="maida-btn" onclick="markMaida()">‚úÖ Mark Today Clean</button>
    </div>
    <div id="maidaLog" style="background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden;"></div>
  </div>
</div>

<!-- HISTORY PAGE -->
<div id="p-history" class="page">
  <div class="nav-back" onclick="nav('p-home')">‚Üê Dashboard</div>
  <div class="header" style="padding-top:8px;">
    <div class="page-title">HISTORY</div>
  </div>
  <div id="historyContainer" style="padding: 0 20px;"></div>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <h2>Settings</h2>

    <h3>Daily Calorie Target</h3>
    <input type="number" id="sTarg" value="2200">
    <button class="btn" onclick="saveSettings()">Save Settings</button>

    <hr class="section-divider">
    <h3>Import Meal Plans</h3>
    <p style="font-size:0.78rem; color:var(--text-sec); margin-bottom:12px;">Paste a Weekly Object or Daily Array:</p>
    <textarea id="importPlanArea" placeholder='{ "nonVeg": {...}, "veg": {...} } OR [...]'></textarea>
    <button class="btn btn-sec" onclick="importPlanData()">Import Plan</button>

    <hr class="section-divider">
    <h3>Import Food Database</h3>
    <p style="font-size:0.78rem; color:var(--text-sec); margin-bottom:12px;">Paste array of foods:</p>
    <textarea id="importCustomArea" placeholder='[{"n": "Apple", "c": 95}]'></textarea>
    <button class="btn btn-sec" onclick="importCustomData()">Save to Database</button>

    <button class="btn btn-danger" onclick="resetApp()">Hard Reset App</button>
    <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('settingsModal')">Close</button>
  </div>
</div>

<!-- CUSTOM ENTRY MODAL -->
<div id="customModal" class="modal">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <h2>Log Custom Entry</h2>

    <div class="search-wrapper">
      <input type="text" id="cName" placeholder="Search food database..." autocomplete="off" oninput="handleCustomSearch()">
      <div id="autocomplete-list" class="autocomplete-list"></div>
    </div>

    <div style="display:flex; gap:12px; margin-bottom:12px;">
      <input type="number" id="cWeight" placeholder="Weight (g/ml)" oninput="calcCustomCal()" style="margin-bottom:0; flex:1;">
      <input type="number" id="cCal" placeholder="Calories (kcal)" style="margin-bottom:0; flex:1;">
    </div>

    <button class="btn" onclick="addCustom()">Log Entry</button>
    <button class="btn btn-sec" onclick="closeModal('customModal')">Cancel</button>
  </div>
</div>

<script>
const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
let dailyPlan = [];
let weeklyPlan = {};
let weeklyPlanVeg = {};

let app = {
  userName: "ATHARV",
  target: 2200,
  checks: {},
  water: 0,
  custom: [],
  streak: 0,
  lastLog: "",
  maidaDates: [],
  theme: 'dark',
  history: [],
  vegDate: "",
  isVegToday: false,
  foodDB: []
};

function init() {
  const saved = localStorage.getItem('fit_ultra_final_v36');
  if (saved) {
    const p = JSON.parse(saved);
    app = { ...app, ...p.app };
    if (p.plan && typeof p.plan === 'object' && !Array.isArray(p.plan)) weeklyPlan = p.plan;
    if (p.planVeg && typeof p.planVeg === 'object' && !Array.isArray(p.planVeg)) weeklyPlanVeg = p.planVeg;
  }

  let now = new Date();
  let today = now.toDateString();
  let currentDayName = daysOfWeek[now.getDay()];

  if (app.lastLog !== today) {
    if (app.lastLog) {
      let yesterCal = 0;
      let loggedDate = new Date(app.lastLog);
      let loggedDayName = daysOfWeek[loggedDate.getDay()];
      let yesterPlanList = (app.vegDate === app.lastLog && app.isVegToday) ? weeklyPlanVeg[loggedDayName] : weeklyPlan[loggedDayName];
      yesterPlanList = yesterPlanList || [];
      yesterPlanList.forEach((m, i) => { if (app.checks[i]) yesterCal += (m.calories || 0); });
      app.custom.forEach(c => yesterCal += c.c);
      if (yesterCal > 0 || app.water > 0) {
        if (!app.history) app.history = [];
        app.history.unshift({ date: app.lastLog, cals: yesterCal, water: app.water });
        if (app.history.length > 30) app.history.pop();
      }
      let yest = new Date(); yest.setDate(now.getDate() - 1);
      if (app.lastLog === yest.toDateString()) app.streak++;
      else app.streak = 0;
    }
    app.checks = {}; app.water = 0; app.custom = []; app.lastLog = today;
    app.isVegToday = false; app.vegDate = today;
    save();
  }

  if (app.vegDate !== today) { app.isVegToday = false; app.vegDate = today; save(); }

  dailyPlan = app.isVegToday ? (weeklyPlanVeg[currentDayName] || []) : (weeklyPlan[currentDayName] || []);

  if (app.theme === 'light') {
    document.body.classList.add('light-mode');
    document.getElementById('themeBtn').innerText = 'üåô';
  } else {
    document.body.classList.remove('light-mode');
    document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
  }

  document.getElementById('userName').innerText = app.userName;
  document.getElementById('sTarg').value = app.target;
  document.getElementById('dayLabel').innerText = currentDayName.toUpperCase();
  document.getElementById('homeDayLabel').innerText = currentDayName.toUpperCase() + "'S PLAN";

  updateTodayVegUI();
  render();
  setTimeout(scrollToNextMeal, 600);
}

function toggleTheme() {
  document.body.classList.toggle('light-mode');
  app.theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
  document.getElementById('themeBtn').innerText = app.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
  save(); render();
}

function toggleTodayVeg() {
  let d = daysOfWeek[new Date().getDay()];
  app.isVegToday = !app.isVegToday;
  app.vegDate = new Date().toDateString();
  dailyPlan = app.isVegToday ? (weeklyPlanVeg[d] || []) : (weeklyPlan[d] || []);
  updateTodayVegUI(); save(); render();
  showToast(app.isVegToday ? "ü•¶ Switched to Veg" : "üçó Non-Veg Mode");
}

function updateTodayVegUI() {
  let track = document.getElementById('todayVegTrack');
  let label = document.getElementById('todayVegLabel');
  if (app.isVegToday) { track.classList.add('is-veg'); label.innerText = "VEG"; label.style.color = "var(--a-green)"; }
  else { track.classList.remove('is-veg'); label.innerText = "NON-VEG"; label.style.color = "var(--text-sec)"; }
}

function render() {
  const colors = ['#FF4D6D', '#00D4FF', '#FF9F0A', '#C77DFF', '#00E5A0', '#4D9EFF'];
  const now = new Date();
  const currentMins = now.getHours() * 60 + now.getMinutes();
  let nextIdx = -1, totalCal = 0;

  document.getElementById('mealContainer').innerHTML = dailyPlan.map((m, i) => {
    let isChk = app.checks[i];
    if (isChk) totalCal += (m.calories || m.c || 0);
    let color = colors[i % colors.length];
    let tVal = parseTime(m.time);
    if (nextIdx === -1 && tVal > currentMins && !isChk) nextIdx = i;
    let isNext = (i === nextIdx);

    let itemsHtml = (m.items || []).map(x => `
      <div class="ing-row">
        <div class="ing-left">
          <div class="ing-bullet"></div>
          <span class="ing-left-text">${x.food}</span>
        </div>
        <div class="ing-tag">${x.weight}</div>
      </div>`).join('');

    return `
      <div class="meal-card ${isChk ? 'checked' : ''} ${isNext ? 'highlight' : ''}" id="meal-${i}" style="--accent-color:${color}; --accent-rgb:${hexToRgb(color)}">
        <div class="next-badge">Next Up</div>
        <div class="check-box" onclick="togMeal(${i})">‚úì</div>
        <div class="mc-content" onclick="togMeal(${i})">
          <div class="mc-top">
            <span class="mc-time" style="color:${color}">${m.time}</span>
            <span class="mc-cal">${m.calories || 0} kcal</span>
          </div>
          <div class="mc-title">${m.n || getPhaseName(m.time)}</div>
          <div>${itemsHtml}</div>
        </div>
      </div>`;
  }).join('') || '<div style="text-align:center; padding:40px 20px; color:var(--text-muted); font-size:0.9rem; line-height:1.6;">No meals scheduled.<br>Import your plan in settings.</div>';

  app.custom.forEach(c => totalCal += c.c);
  document.getElementById('customList').innerHTML = app.custom.map((c, i) => {
    let cCol = colors[(dailyPlan.length + i) % colors.length];
    let fName = c.n;
    let fWeight = "Logged";
    if (c.n.includes('(')) {
      let parts = c.n.split(/\(([^)]+)\)/);
      fName = parts[0].trim();
      if (parts[1]) fWeight = parts[1].trim();
    }
    return `
      <div class="meal-card" style="--accent-color:${cCol}; --accent-rgb:${hexToRgb(cCol)}">
        <div class="check-box" style="border-color:var(--a-red); color:var(--a-red); background:var(--surface);" onclick="delCust(${i})">‚úï</div>
        <div class="mc-content">
          <div class="mc-top">
            <span class="mc-time" style="color:${cCol}">EXTRA</span>
            <span class="mc-cal">${c.c} kcal</span>
          </div>
          <div class="mc-title">${fName}</div>
          <div class="ing-row">
            <div class="ing-left"><div class="ing-bullet"></div><span class="ing-left-text">Custom Entry</span></div>
            <div class="ing-tag">${fWeight}</div>
          </div>
        </div>
      </div>`;
  }).join('') || '<div style="text-align:center; color:var(--text-muted); padding:20px; font-size:0.85rem;">No extras logged yet</div>';

  document.getElementById('dispStreak').innerText = app.streak;
  document.getElementById('waterVal').innerText = app.water.toFixed(1);
  document.getElementById('maidaStreakVal').innerText = app.maidaDates.length;
  document.getElementById('maidaStreakValHome').innerText = app.maidaDates.length;
  document.getElementById('maidaLog').innerHTML = app.maidaDates.length ? app.maidaDates.map(d => `
    <div class="maida-log-item">
      <span style="color:var(--text-sec); font-size:0.88rem; font-weight:500;">üìÖ ${d}</span>
      <span style="color:var(--a-green); font-size:0.78rem; font-weight:700; letter-spacing:0.5px;">CLEAN ‚úì</span>
    </div>`).join('') : '<div style="text-align:center; color:var(--text-muted); padding:30px; font-size:0.85rem;">No records yet</div>';

  let pct = Math.min(1, totalCal / app.target);
  document.getElementById('calPct').innerText = Math.round(pct * 100) + "%";
  document.getElementById('progCirc').style.strokeDashoffset = 175 - (175 * pct);
  document.getElementById('mealPageCal').innerText = `${totalCal} / ${app.target}`;
  document.getElementById('sbFill').style.width = (pct * 100) + "%";

  renderShop(); renderHistory();
}

function renderShop() {
  let pantry = {};
  const block = ['water', 'walk', 'run', 'gym', 'workout'];
  dailyPlan.forEach(m => {
    if (m.items) m.items.forEach(i => {
      let n = i.food, w = i.weight;
      if (!n) return;
      let clean = n.replace(/\(.*?\)/g, "").trim();
      if (block.some(b => clean.toLowerCase().includes(b))) return;
      if (!pantry[clean]) pantry[clean] = [];
      pantry[clean].push(w);
    });
  });
  document.getElementById('shopContainer').innerHTML = Object.keys(pantry).map(k => `
    <div class="shop-row" onclick="this.classList.toggle('done')">
      <span class="shop-name">${k}</span>
      <span class="shop-qty">${pantry[k].join(" + ")}</span>
    </div>`).join('') || '<div style="text-align:center; color:var(--text-muted); padding:40px; font-size:0.88rem;">Shopping list is empty today</div>';
}

function renderHistory() {
  if (!app.history || app.history.length === 0) {
    document.getElementById('historyContainer').innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:40px; font-size:0.88rem; line-height:1.8;">No history yet.<br>Complete a day to see your stats.</div>';
    return;
  }
  document.getElementById('historyContainer').innerHTML = app.history.map(h => {
    let dObj = new Date(h.date);
    let day = dObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    return `
      <div class="hist-row">
        <div class="hist-date">${day}</div>
        <div class="hist-data">
          <div class="hist-val">${h.cals} kcal</div>
          <div class="hist-sub">${h.water}L water</div>
        </div>
      </div>`;
  }).join('');
}

function togMeal(i) {
  if (app.checks[i]) delete app.checks[i];
  else {
    app.checks[i] = true;
    confetti({ particleCount: 80, spread: 65, origin: { y: 0.6 }, colors: ['#00E5A0', '#4D9EFF', '#C77DFF'] });
  }
  save(); render();
}

function importPlanData() {
  let input = document.getElementById('importPlanArea').value.trim();
  let d = daysOfWeek[new Date().getDay()];
  if (!input) { showToast("Paste code first"); return; }
  try {
    let clean = input;
    if (clean.includes('=')) clean = clean.split('=').pop().trim();
    if (clean.endsWith(';')) clean = clean.slice(0, -1);
    let newData = new Function("return " + clean)();
    if (Array.isArray(newData)) {
      if (app.isVegToday) { if (!weeklyPlanVeg) weeklyPlanVeg = {}; weeklyPlanVeg[d] = newData; }
      else { if (!weeklyPlan) weeklyPlan = {}; weeklyPlan[d] = newData; }
      dailyPlan = newData; app.checks = {};
      save(); render(); closeModal('settingsModal');
      document.getElementById('importPlanArea').value = '';
      showToast("Plan updated!");
    } else if (newData && newData.nonVeg && newData.veg) {
      weeklyPlan = newData.nonVeg; weeklyPlanVeg = newData.veg;
      dailyPlan = app.isVegToday ? (weeklyPlanVeg[d] || []) : (weeklyPlan[d] || []);
      app.checks = {}; save(); render(); closeModal('settingsModal');
      document.getElementById('importPlanArea').value = '';
      showToast("Veg & Non-Veg plans updated!");
    } else if (typeof newData === 'object') {
      weeklyPlan = newData; weeklyPlanVeg = JSON.parse(JSON.stringify(newData));
      dailyPlan = app.isVegToday ? (weeklyPlanVeg[d] || []) : (weeklyPlan[d] || []);
      app.checks = {}; save(); render(); closeModal('settingsModal');
      document.getElementById('importPlanArea').value = '';
      showToast("Plan updated!");
    } else { showToast("Invalid format"); }
  } catch (e) { showToast("Error parsing code"); console.error(e); }
}

function importCustomData() {
  let input = document.getElementById('importCustomArea').value.trim();
  if (!input) { showToast("Paste database code"); return; }
  try {
    let clean = input;
    if (clean.includes('=')) clean = clean.split('=').pop().trim();
    if (clean.endsWith(';')) clean = clean.slice(0, -1);
    let newData = new Function("return " + clean)();
    if (Array.isArray(newData)) {
      let valid = newData.filter(item => item.n && item.c);
      if (valid.length > 0) {
        app.foodDB = valid; save(); closeModal('settingsModal');
        document.getElementById('importCustomArea').value = '';
        showToast(`${valid.length} foods saved!`);
      } else { showToast("No valid foods found"); }
    } else { showToast("Must be an Array"); }
  } catch (e) { showToast("Error parsing code"); console.error(e); }
}

function handleCustomSearch() {
  let val = document.getElementById('cName').value.toLowerCase();
  let list = document.getElementById('autocomplete-list');
  list.innerHTML = '';
  if (!val) { list.classList.remove('show'); return; }
  let matches = (app.foodDB || []).filter(f => f.n.toLowerCase().includes(val));
  if (matches.length === 0) { list.classList.remove('show'); return; }
  matches.slice(0, 10).forEach(m => {
    let div = document.createElement('div');
    div.className = 'autocomplete-item';
    let dn = m.n.replace(/\s*\(\s*100g\s*\)/i, '');
    div.innerHTML = `<strong>${dn}</strong><span>${m.c}/100g</span>`;
    div.onclick = () => { document.getElementById('cName').value = m.n; list.classList.remove('show'); calcCustomCal(); };
    list.appendChild(div);
  });
  list.classList.add('show');
  calcCustomCal();
}

document.addEventListener('click', function(e) {
  if (e.target.id !== "cName") {
    let list = document.getElementById('autocomplete-list');
    if (list) list.classList.remove('show');
  }
});

function calcCustomCal() {
  let n = document.getElementById('cName').value;
  let w = parseFloat(document.getElementById('cWeight').value);
  let calInput = document.getElementById('cCal');
  let match = (app.foodDB || []).find(x => x.n === n);
  if (match) {
    if (!isNaN(w) && w > 0) calInput.value = Math.round((match.c / 100) * w);
    else calInput.value = match.c;
  }
}

function scrollToNextMeal() {
  let el = document.querySelector('.meal-card.highlight');
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function nav(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
  if (id === 'p-meal') setTimeout(scrollToNextMeal, 300);
}

function markMaida() {
  let d = new Date().toISOString().split('T')[0];
  if (!app.maidaDates.includes(d)) {
    app.maidaDates.push(d); app.maidaDates.sort().reverse();
    save(); render();
    showToast("üéâ Maida streak +1!");
    confetti({ particleCount: 140, spread: 80, colors: ['#4D9EFF', '#C77DFF', '#00E5A0'] });
  } else { showToast("Already logged today!"); }
}

function modWater(n) {
  app.water = parseFloat((app.water + n).toFixed(2));
  save(); render();
  showToast(`üíß +${n * 1000}ml`);
}

function addCustom() {
  let n = document.getElementById('cName').value.trim();
  let w = document.getElementById('cWeight').value.trim();
  let c = parseInt(document.getElementById('cCal').value);
  if (n && c) {
    let finalName = n;
    if (w && !isNaN(w)) finalName = n.replace(/\s*\(\s*100g\s*\)/i, '') + ` (${w}g)`;
    else if (w) finalName = n.replace(/\s*\(\s*100g\s*\)/i, '') + ` (${w})`;
    app.custom.push({ n: finalName, c: c });
    save(); render(); closeModal('customModal');
    showToast("Entry logged!");
    document.getElementById('cName').value = '';
    document.getElementById('cWeight').value = '';
    document.getElementById('cCal').value = '';
  } else { showToast("Fill name & calories"); }
}

function delCust(i) { app.custom.splice(i, 1); save(); render(); showToast("Entry removed"); }
function editName() {
  let n = prompt("Your name:", app.userName);
  if (n && n.trim()) { app.userName = n.trim(); save(); init(); }
}

function parseTime(val) {
  if (!val) return 0;
  let clean = val.toLowerCase().replace(/\s+/g, '');
  let isPM = clean.includes('pm'), isAM = clean.includes('am');
  let m = clean.match(/(\d+):(\d+)/);
  if (!m) return 0;
  let h = parseInt(m[1]), min = parseInt(m[2]);
  if (isPM && h !== 12) h += 12;
  if (isAM && h === 12) h = 0;
  return h * 60 + min;
}

function hexToRgb(hex) {
  let r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return r ? `${parseInt(r[1], 16)}, ${parseInt(r[2], 16)}, ${parseInt(r[3], 16)}` : '255,255,255';
}

function getPhaseName(t) {
  let v = parseTime(t);
  if (v < 360) return "Pre-Workout"; if (v < 600) return "Breakfast";
  if (v < 720) return "Morning Snack"; if (v < 900) return "Lunch";
  if (v < 1080) return "Evening Snack"; return "Dinner";
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) {
  document.getElementById(id).classList.remove('active');
  let list = document.getElementById('autocomplete-list');
  if (list) list.classList.remove('show');
}

function save() { localStorage.setItem('fit_ultra_final_v36', JSON.stringify({ app, plan: weeklyPlan, planVeg: weeklyPlanVeg })); }
function saveSettings() { app.target = parseInt(document.getElementById('sTarg').value); save(); render(); closeModal('settingsModal'); showToast("Settings saved!"); }
function resetApp() { if (confirm("Hard reset? All data will be deleted.")) { localStorage.clear(); location.reload(); } }

function showToast(m) {
  let t = document.getElementById('toast');
  document.getElementById('toastMsg').innerText = m;
  document.getElementById('toastEmoji').style.display = 'none';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

init();
</script>
</body>
</html>
