<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pro FitHub: Perfect Dim</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
    /* --- CORE VARIABLES (DARK MODE) --- */
    :root {
        --bg: #000000;
        --text: #ffffff;
        --text-sec: #cccccc;
        --card-bg: rgba(20, 20, 20, 0.6);
        --card-border: 1px solid rgba(255, 255, 255, 0.08);
        --input-bg: #080808;
        --modal-bg: #111111;
        
        /* DARK MODE GRADIENTS: Color -> Black Shadow */
        --g-orange: linear-gradient(to right, rgba(255, 69, 0, 0.4), rgba(0, 0, 0, 0.8));
        --g-green:  linear-gradient(to right, rgba(0, 200, 83, 0.4), rgba(0, 0, 0, 0.8));
        --g-blue:   linear-gradient(to right, rgba(41, 121, 255, 0.4), rgba(0, 0, 0, 0.8));
        --g-purple: linear-gradient(to right, rgba(191, 90, 242, 0.4), rgba(0, 0, 0, 0.8));
        --g-cyan:   linear-gradient(to right, rgba(0, 229, 255, 0.4), rgba(0, 0, 0, 0.8));
        --g-gold:   linear-gradient(to right, rgba(255, 215, 0, 0.4), rgba(0, 0, 0, 0.8));
        
        --shadow-depth: 0 10px 30px -10px rgba(0,0,0,0.8);
        --text-glow: 0 4px 15px rgba(0,0,0,1);
        --emoji-op: 0.25;
        --emoji-filter: grayscale(0.2) drop-shadow(0 0 10px rgba(255,255,255,0.1));
        
        --tag-bg: rgba(255,255,255,0.08);
        --bullet-color: #FF3B30;
        
        --font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --border-radius: 26px;
    }

    /* --- LIGHT MODE VARIABLES (UPDATED GRADIENTS) --- */
    body.light-mode {
        --bg: #F0F2F5;
        --text: #111111;
        --text-sec: #444444;
        --card-bg: #ffffff;
        --card-border: 1px solid rgba(0, 0, 0, 0.08);
        --input-bg: #ffffff;
        --modal-bg: #ffffff;

        /* LIGHT MODE GRADIENTS: Vivid -> Deep Contrast 
           This replicates the "dimming" effect by fading into a darker shade of the same color,
           ensuring the white text stays readable.
        */
        --g-orange: linear-gradient(to right, #FF8A65, #BF360C); /* Coral -> Deep Rust */
        --g-green:  linear-gradient(to right, #4ADE80, #14532D); /* Mint -> Dark Forest */
        --g-blue:   linear-gradient(to right, #60A5FA, #1E3A8A); /* Sky -> Deep Navy */
        --g-purple: linear-gradient(to right, #C084FC, #581C87); /* Lilac -> Deep Grape */
        --g-cyan:   linear-gradient(to right, #22D3EE, #0F766E); /* Cyan -> Deep Teal */
        --g-gold:   linear-gradient(to right, #FACC15, #854D0E); /* Yellow -> Deep Bronze */
        
        --shadow-depth: 0 10px 25px -5px rgba(0,0,0,0.15);
        --text-glow: 0 2px 4px rgba(0,0,0,0.3);
        --emoji-op: 0.5;
        --emoji-filter: none;
        
        --tag-bg: #E0E0E0;
        --bullet-color: #000000;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
    
    body {
        background-color: var(--bg);
        color: var(--text);
        font-family: var(--font);
        margin: 0; padding: 0; padding-bottom: 50px;
        overflow-x: hidden; transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* --- ANIMATIONS --- */
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes float { 0% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-8px) rotate(3deg); } 100% { transform: translateY(0px) rotate(0deg); } }
    @keyframes pulse-border { 0% { border-color: var(--accent-color); } 50% { border-color: #fff; box-shadow: 0 0 15px var(--accent-color); } 100% { border-color: var(--accent-color); } }
    @keyframes barMove { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }

    /* --- HEADER --- */
    .header { padding: 30px 24px 15px 24px; display: flex; justify-content: space-between; align-items: center; }
    .welcome-sub { font-size: 0.7rem; font-weight: 700; color: var(--text-sec); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 2px; }
    .app-title { font-size: 1.6rem; font-weight: 900; letter-spacing: -0.5px; color: var(--text); }
    body:not(.light-mode) .app-title { text-shadow: var(--text-glow); }
    
    .head-actions { display: flex; gap: 12px; }

    .icon-btn {
        width: 40px; height: 40px; border-radius: 50%;
        background: var(--card-bg); border: var(--card-border);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.1rem; cursor: pointer; transition: 0.2s;
        box-shadow: var(--shadow-depth); color: var(--text);
    }
    .icon-btn:active { transform: scale(0.92); }

    /* --- GRID & CARDS --- */
    .grid { padding: 0 24px; display: flex; flex-direction: column; gap: 16px; }

    .card {
        border-radius: var(--border-radius); padding: 22px;
        position: relative; overflow: hidden; cursor: pointer; display: flex; flex-direction: column; justify-content: center;
        border: var(--card-border); backdrop-filter: blur(10px);
        box-shadow: var(--shadow-depth); transition: transform 0.2s;
    }
    .card:active { transform: scale(0.98); opacity: 0.9; }

    .bg-icon {
        position: absolute; right: 15px; top: 50%; margin-top: -30px; 
        font-size: 4.5rem; opacity: var(--emoji-op); z-index: 0;
        filter: var(--emoji-filter); pointer-events: none;
        animation: float 5s ease-in-out infinite;
    }
    .card-content { position: relative; z-index: 2; width: 100%; }

    /* COLOR MODES - TEXT OVERRIDES */
    /* Ensure text on colored cards is always white, even in light mode, because backgrounds are dark/vivid */
    body.light-mode .c-streak, body.light-mode .c-meal, body.light-mode .c-maida, body.light-mode .c-history, body.light-mode .c-water, body.light-mode .c-shop { color: #ffffff !important; }
    
    body.light-mode .streak-lbl, body.light-mode .c-meal-title, body.light-mode .streak-val, body.light-mode .sc-val, body.light-mode .sc-lbl { 
        color: #ffffff !important; opacity: 1 !important; text-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
    }

    .c-streak { background: var(--g-orange); border-color: rgba(255, 69, 0, 0.3); }
    .c-meal { background: var(--g-green); border-color: rgba(0, 200, 83, 0.3); }
    .c-water { background: var(--g-cyan); border-color: rgba(0, 229, 255, 0.3); }
    .c-shop { background: var(--g-purple); border-color: rgba(191, 90, 242, 0.3); }
    .c-maida { background: var(--g-blue); border-color: rgba(41, 121, 255, 0.3); }
    .c-history { background: var(--g-gold); border-color: rgba(255, 215, 0, 0.3); }

    .streak-lbl { font-size: 0.7rem; font-weight: 800; opacity: 0.7; letter-spacing: 1.5px; text-transform: uppercase; color: #ddd; text-shadow: var(--text-glow); }
    .streak-val { font-size: 2.6rem; font-weight: 900; line-height: 1; display:flex; align-items:baseline; gap:6px; margin-top: 6px; text-shadow: var(--text-glow); }
    .c-meal-title { font-size: 1.5rem; font-weight: 900; line-height: 1; margin-top: 6px; letter-spacing: -0.3px; text-shadow: var(--text-glow); }

    /* BIGGER CIRCULAR PROGRESS */
    .mc-prog { 
        position: absolute; right: 15px; top: 50%; transform: translateY(-50%); 
        width: 85px; height: 85px; 
        display: flex; align-items: center; justify-content: center; z-index: 2; 
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); 
    }
    .mc-prog svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .mc-bg { stroke: rgba(255,255,255,0.3); }
    .mc-fill { stroke: #fff; stroke-dasharray: 175; stroke-dashoffset: 175; transition: 1s; stroke-linecap: round; }
    .mc-pct { font-size: 0.9rem; font-weight: 900; position: absolute; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

    .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    
    /* LEFT ALIGNED SMALL CARDS */
    .small-card { 
        min-height: 150px; border-radius: var(--border-radius); 
        padding: 20px 10px; 
        display: flex; flex-direction: column; justify-content: space-between; 
        position: relative; overflow: hidden; backdrop-filter: blur(10px); 
        border: var(--card-border); background: var(--card-bg); 
    }
    
    body.light-mode .small-card.c-water { background: var(--g-cyan); color: #fff; }
    body.light-mode .small-card.c-shop { background: var(--g-purple); color: #fff; }
    
    .small-card .bg-icon { font-size: 3.5rem; right: -10px; bottom: 5px; top: auto; opacity: 0.2; }
    .sc-val { font-size: 1.6rem; font-weight: 900; color: inherit; margin: 4px 0; text-shadow: var(--text-glow); }
    .sc-lbl { font-size: 0.65rem; color: inherit; opacity: 0.9; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; text-shadow: var(--text-glow); }

    /* --- MEAL LIST & STICKY BAR --- */
    .meal-list { padding: 0 24px; margin-top: 10px; }

    .sticky-bar-container {
        position: sticky; top: 0; z-index: 100;
        background: rgba(var(--bg-rgb), 0.95);
        backdrop-filter: blur(15px);
        padding: 15px 24px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        margin-bottom: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    body.light-mode .sticky-bar-container { background: rgba(240, 242, 245, 0.95); border-bottom: 1px solid rgba(0,0,0,0.05); }

    .sb-info { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
    .sb-title { font-size: 0.8rem; font-weight: 800; color: var(--text-sec); letter-spacing: 1px; text-transform: uppercase; }
    .sb-val { font-size: 1.1rem; font-weight: 900; color: var(--text); }
    
    .sb-track { width: 100%; height: 8px; background: rgba(128,128,128,0.2); border-radius: 10px; overflow: hidden; position: relative; }
    .sb-fill {
        height: 100%; width: 0%; border-radius: 10px;
        background: linear-gradient(90deg, #FF3B30, #FF9500, #FFCC00, #4CD964, #5AC8FA, #007AFF, #5856D6, #FF2D55);
        background-size: 400% 100%;
        animation: barMove 4s linear infinite;
        transition: width 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .meal-card {
        background: var(--card-bg); border: var(--card-border); border-radius: 20px; margin-bottom: 20px;
        position: relative; overflow: hidden; padding-left: 5px; 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-depth); color: var(--text);
    }
    .meal-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: var(--accent-color); }
    .meal-card.highlight {
        border: 2px solid var(--accent-color) !important;
        box-shadow: 0 0 25px rgba(var(--accent-rgb), 0.2);
        transform: scale(1.01); z-index: 5;
        animation: pulse-border 2s infinite; background: var(--card-bg);
    }
    
    .next-badge {
        position: absolute; top: 0; right: 55px;
        background: #FF3B30; color: #fff;
        font-size: 0.6rem; font-weight: 900; padding: 5px 12px;
        border-bottom-left-radius: 12px; display: none; text-transform: uppercase;
        z-index: 10; letter-spacing: 0.5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        text-shadow: none !important;
    }
    .meal-card.highlight .next-badge { display: block; }

    .mc-content { padding: 20px; cursor: pointer; }
    .mc-top { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; padding-right: 40px; }
    .mc-time { color: var(--accent-color); font-weight: 800; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; text-shadow:none; }
    .mc-cal { background: rgba(128,128,128,0.1); color: var(--text-sec); padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 0.7rem; border: 1px solid rgba(128,128,128,0.2); }
    .mc-title { font-size: 1.4rem; font-weight: 800; color: var(--text); margin-bottom: 15px; letter-spacing: -0.3px; line-height: 1.2; padding-right: 40px; text-shadow:none; }

    .ing-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed rgba(128,128,128,0.2); }
    .ing-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .ing-left { display: flex; align-items: center; color: var(--text-sec); font-weight: 600; font-size: 0.95rem; }
    .ing-bullet { width: 6px; height: 6px; border-radius: 50%; background: var(--bullet-color); margin-right: 12px; flex-shrink: 0; }
    .ing-tag { background: var(--tag-bg); color: var(--text); font-weight: 700; font-size: 0.8rem; padding: 5px 12px; border-radius: 8px; min-width: 60px; text-align: center; border: 1px solid rgba(128,128,128,0.15); }

    .check-box {
        position: absolute; top: 18px; right: 18px; z-index: 10;
        width: 34px; height: 34px; border: 2px solid var(--text-sec); 
        border-radius: 50%; display: flex; align-items: center; justify-content: center; 
        cursor: pointer; background: var(--bg); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 1.1rem; color: transparent;
    }
    .check-box:hover { border-color: var(--text); transform: scale(1.1); }
    .meal-card.checked { opacity: 0.5; filter: grayscale(1); }
    .meal-card.checked .check-box { background: #00E676; border-color: #00E676; color: #000; box-shadow: 0 0 15px rgba(0, 230, 118, 0.4); }

    .page { display: none; padding: 0; animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .page.active { display: block; }
    
    .nav-back {
        margin: 0 24px 15px 24px; display: inline-flex; align-items: center; gap: 8px;
        background: var(--card-bg); padding: 12px 24px; border-radius: 30px; 
        font-weight: 700; color: var(--text); cursor: pointer; border: var(--card-border);
        transition: 0.2s; box-shadow: var(--shadow-depth);
    }
    .nav-back:active { transform: scale(0.95); }

    .shop-row, .hist-row { background: var(--card-bg); padding: 18px; border-radius: 16px; margin-bottom: 10px; border: var(--card-border); display: flex; justify-content: space-between; align-items: center; cursor:pointer; box-shadow: var(--shadow-depth); color:var(--text); }
    .shop-row.done { opacity: 0.3; text-decoration: line-through; }
    .shop-qty { background: rgba(0, 230, 118, 0.1); padding: 5px 12px; border-radius: 8px; font-weight: 700; color: #00E676; font-size: 0.9rem; }
    
    .hist-row { cursor: default; }
    .hist-date { font-weight: 700; opacity: 0.8; font-size: 0.9rem; }
    .hist-data { text-align: right; }
    .hist-val { font-weight: 800; font-size: 1rem; color: #fff; }
    body.light-mode .hist-val { color: #000; }
    .hist-sub { font-size: 0.75rem; color: var(--text-sec); font-weight: 600; }

    .maida-btn { width: 100%; padding: 22px; margin-top: 25px; background: #fff; color: #000; font-weight: 900; font-size: 1.1rem; border: none; border-radius: 20px; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    body.light-mode .maida-btn { background: #111; color: #fff; }
    .maida-btn:active { transform: scale(0.98); opacity: 0.9; }

    /* MODALS */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-box { background: var(--modal-bg); padding: 30px; width: 90%; max-width: 400px; border-radius: 28px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); color: var(--text); }
    body.light-mode .modal-box { border: 1px solid rgba(0,0,0,0.1); background: #fff; }
    h2 { margin-top: 0; color: var(--text); font-size: 1.5rem; }
    
    input, textarea { width: 100%; padding: 18px; background: var(--input-bg); border: 1px solid rgba(128,128,128,0.2); color: var(--text); border-radius: 14px; margin-bottom: 15px; font-family: var(--font); font-size: 1rem; outline: none; }
    input:focus { border-color: var(--text); }
    textarea { height: 150px; font-family: monospace; font-size: 0.8rem; line-height: 1.4; color: #00E676; }
    
    .btn { width: 100%; padding: 18px; background: var(--text); color: var(--bg); font-weight: 800; border: none; border-radius: 16px; cursor: pointer; margin-top: 5px; font-size: 1rem; }
    .btn:active { opacity: 0.8; }
    .btn-sec { background: transparent; border: 1px solid var(--text-sec); color: var(--text); margin-top: 12px; }

    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color:#fff; padding: 12px 24px; border-radius: 40px; z-index: 3000; border: 1px solid #444; opacity: 0; transition: 0.3s; pointer-events: none; font-weight: 700; display: flex; gap: 10px; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .toast.show { opacity: 1; top: 50px; }

    .water-actions { display: flex; gap: 5px; margin-top: 15px; }
    .water-btn {
        flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
        color: inherit; padding: 12px 5px; border-radius: 12px; font-weight: 700;
        font-size: 0.9rem; cursor: pointer; transition: 0.2s;
        backdrop-filter: blur(4px); white-space: nowrap;
    }
    .water-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.4); }
</style>
</head>
<body>

<div class="toast" id="toast"><span>‚úÖ</span> <span id="toastMsg">Saved</span></div>

<div id="p-home" class="page active">
    <div class="header">
        <div onclick="editName()">
            <div class="welcome-sub">WELCOME BACK,</div>
            <div class="app-title" id="userName">ATHARV ‚úé</div>
        </div>
        <div class="head-actions">
            <div class="icon-btn" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è</div>
            <div class="icon-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</div>
        </div>
    </div>

    <div class="grid">
        <div class="card c-streak">
            <div class="bg-icon">üèÜ</div>
            <div class="card-content">
                <div class="streak-lbl">CURRENT STREAK</div>
                <div class="streak-val"><span id="dispStreak">0</span><span style="font-size:1.4rem; opacity:0.9; font-weight:800; margin-left:4px;">DAYS</span></div>
            </div>
        </div>

        <div class="card c-meal" onclick="nav('p-meal')">
            <div class="bg-icon">ü•ó</div>
            <div class="card-content">
                <div class="streak-lbl">TODAY'S FUEL</div>
                <div class="c-meal-title">MEAL PLAN</div>
                <div style="font-size:0.8rem; font-weight:700; opacity:0.9; margin-top:6px;">Tap to View Details</div>
            </div>
            <div class="mc-prog">
                <svg viewBox="0 0 70 70">
                    <circle class="mc-bg" cx="35" cy="35" r="28" stroke-width="6" fill="none" />
                    <circle class="mc-fill" id="progCirc" cx="35" cy="35" r="28" stroke-width="6" fill="none" />
                </svg>
                <div class="mc-pct" id="calPct">0%</div>
            </div>
        </div>

        <div class="split">
            <div class="small-card c-water">
                <div class="bg-icon">üíß</div>
                <div class="card-content">
                    <div class="sc-lbl">HYDRATION</div>
                    <div class="sc-val"><span id="waterVal">0.0</span>L</div>
                    <div class="water-actions">
                        <button class="water-btn" onclick="event.stopPropagation(); modWater(0.25);">+250ml</button>
                        <button class="water-btn" onclick="event.stopPropagation(); modWater(0.5);">+500ml</button>
                    </div>
                </div>
            </div>
            <div class="small-card c-shop" onclick="nav('p-shop')">
                <div class="bg-icon">üìù</div>
                <div class="card-content">
                    <div class="sc-lbl">GROCERY</div>
                    <div class="sc-val">SHOPPING</div>
                    <div style="font-size:0.75rem; font-weight:700; opacity:0.8; margin-top:8px;">View List</div>
                </div>
            </div>
        </div>

        <div class="card c-maida" onclick="nav('p-maida')">
            <div class="bg-icon">üö´</div>
            <div class="card-content">
                <div class="streak-lbl">DISCIPLINE TRACKER</div>
                <div class="c-meal-title">NO MAIDA</div>
                <div style="font-size:0.8rem; font-weight:700; opacity:0.9; margin-top:6px;">
                    <span id="maidaStreakValHome">0</span> Days Clean
                </div>
            </div>
        </div>

        <div class="card c-history" onclick="nav('p-history')">
            <div class="bg-icon">üìÖ</div>
            <div class="card-content">
                <div class="streak-lbl">PAST PERFORMANCE</div>
                <div class="c-meal-title">HISTORY</div>
                <div style="font-size:0.8rem; font-weight:700; opacity:0.9; margin-top:6px;">View Daily Intake</div>
            </div>
        </div>
    </div>
</div>

<div id="p-meal" class="page">
    <div class="nav-back" onclick="nav('p-home')">‚Üê DASHBOARD</div>
    <div class="header" style="padding-top:0;">
        <div class="app-title">TODAY'S FUEL</div>
        <div class="icon-btn" onclick="openModal('customModal')">+</div>
    </div>
    
    <div class="sticky-bar-container">
        <div class="sb-info">
            <span class="sb-title">Daily Intake</span>
            <span class="sb-val" id="mealPageCal">0 / 2450</span>
        </div>
        <div class="sb-track">
            <div class="sb-fill" id="sbFill"></div>
        </div>
    </div>

    <div id="mealContainer" class="meal-list"></div>
    <div style="padding:22px; font-weight:800; color:var(--text-sec); font-size:0.75rem; letter-spacing:1px; text-align:center;">CUSTOM LOGS</div>
    <div id="customList" class="meal-list"></div>
</div>

<div id="p-shop" class="page">
    <div class="nav-back" onclick="nav('p-home')">‚Üê DASHBOARD</div>
    <div class="header" style="padding-top:0;"><div class="app-title">SHOPPING LIST</div></div>
    <div id="shopContainer" class="grid"></div>
</div>

<div id="p-maida" class="page">
    <div class="nav-back" onclick="nav('p-home')">‚Üê DASHBOARD</div>
    <div class="header" style="padding-top:0;"><div class="app-title">NO MAIDA CHALLENGE</div></div>
    <div class="grid">
        <div class="card" style="background:var(--card-bg); border:var(--card-border); text-align:center; padding:40px; color:var(--text);">
            <div style="font-size:5rem; margin-bottom:10px;">üçû</div>
            <div style="font-size:3.5rem; font-weight:900;" id="maidaStreakVal">0</div>
            <div class="streak-lbl">DAYS CLEAN</div>
            <button class="maida-btn" onclick="markMaida()">‚úÖ MARK TODAY SUCCESS</button>
        </div>
        <div id="maidaLog" style="margin-top:20px;"></div>
    </div>
</div>

<div id="p-history" class="page">
    <div class="nav-back" onclick="nav('p-home')">‚Üê DASHBOARD</div>
    <div class="header" style="padding-top:0;"><div class="app-title">HISTORY LOGS</div></div>
    <div id="historyContainer" class="grid"></div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-box">
        <h2>Settings</h2>
        <label style="font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:8px;">Daily Calorie Target</label>
        <input type="number" id="sTarg" value="2450">
        <button class="btn" onclick="saveSettings()">SAVE SETTINGS</button>
        
        <div style="margin-top:25px; border-top:1px solid rgba(128,128,128,0.2); padding-top:25px;">
            <h2 style="font-size:1rem; opacity:0.8;">Edit Meal Plan Code</h2>
            <textarea id="importArea" placeholder="Paste your array here..."></textarea>
            <button class="btn" style="background:var(--input-bg); color:var(--text); border:1px solid var(--text-sec);" onclick="importPlan()">UPDATE PLAN FROM CODE</button>
        </div>

        <button class="btn btn-sec" style="color:#ff4444; border-color:#ff4444;" onclick="resetApp()">RESET ALL DATA</button>
        <button class="btn btn-sec" onclick="closeModal('settingsModal')">CLOSE</button>
    </div>
</div>

<div id="customModal" class="modal">
    <div class="modal-box">
        <h2>Add Custom Entry</h2>
        <input type="text" id="cName" placeholder="Food Name">
        <input type="number" id="cCal" placeholder="Calories (Required)">
        <button class="btn" onclick="addCustom()">ADD ENTRY</button>
        <button class="btn btn-sec" onclick="closeModal('customModal')">CANCEL</button>
    </div>
</div>

<script>
/* DATA & LOGIC */
let scientificPlan = [
  { time: "05:30 AM", calories: 160, items: [{ food: "Large Banana", weight: "1 pc" }, { food: "Pumpkin Seeds", weight: "10g" }] },
  { time: "06:00 AM", calories: 0, items: [{ food: "Water", weight: "1 Liter" }] },
  { time: "08:15 AM", calories: 300, items: [{ food: "Whey Protein", weight: "2 Scoops" }, { food: "Apple", weight: "1 Medium" }, { food: "Creatine Monohydrate", weight: "5g" }] },
  { time: "11:00 AM", calories: 680, items: [{ food: "Whole Eggs", weight: "5 pcs" }, { food: "Chocolate Protein Oats", weight: "80g" }] },
  { time: "01:30 PM", calories: 250, items: [{ food: "Roasted Chana", weight: "50g" }, { food: "Orange", weight: "1 pc" }] },
  { time: "04:45 PM", calories: 350, items: [{ food: "Egg Whites", weight: "6 pcs" }, { food: "Whole Eggs", weight: "2 pcs" }, { food: "Kabuli Chana", weight: "50g" }] },
  { time: "07:00 PM", calories: 0, items: [{ food: "Evening Walk", weight: "45 Mins" }] },
  { time: "08:30 PM", calories: 430, items: [{ food: "Soya Chunks (Dry)", weight: "60g" }, { food: "Boiled Moong", weight: "100g" }, { food: "Cucumber Salad", weight: "100g" }] }
];

let app = { userName: "ATHARV", target: 2450, checks: {}, water: 0, custom: [], streak: 0, lastLog: "", maidaDates: [], theme: 'dark', history: [] };

function init() {
    const saved = localStorage.getItem('fit_ultra_final_v20');
    if(saved) {
        const p = JSON.parse(saved);
        app = {...app, ...p.app};
        if(p.plan && Array.isArray(p.plan) && p.plan.length > 0) scientificPlan = p.plan;
    }
    
    // Apply Theme
    if(app.theme === 'light') {
        document.body.classList.add('light-mode');
        document.getElementById('themeBtn').innerText = 'üåô';
    } else {
        document.body.classList.remove('light-mode');
        document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
    }

    const today = new Date().toDateString();
    if(app.lastLog !== today) {
        if(app.lastLog) {
            let yesterCal = 0;
            scientificPlan.forEach((m, i) => { if(app.checks[i]) yesterCal += (m.calories || 0); });
            app.custom.forEach(c => yesterCal += c.c);
            
            if(yesterCal > 0 || app.water > 0) {
                if(!app.history) app.history = [];
                app.history.unshift({ date: app.lastLog, cals: yesterCal, water: app.water });
                if(app.history.length > 30) app.history.pop();
            }

            let yest = new Date(); yest.setDate(yest.getDate()-1);
            if(app.lastLog === yest.toDateString()) app.streak++;
            else app.streak = 0;
        }
        
        app.checks = {}; app.water = 0; app.custom = []; app.lastLog = today;
        save();
    }
    
    document.getElementById('userName').innerText = app.userName + " ‚úé";
    document.getElementById('sTarg').value = app.target;
    render();
    setTimeout(scrollToNextMeal, 500);
}

function toggleTheme() {
    document.body.classList.toggle('light-mode');
    if(document.body.classList.contains('light-mode')) {
        app.theme = 'light';
        document.getElementById('themeBtn').innerText = 'üåô';
    } else {
        app.theme = 'dark';
        document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
    }
    save(); render();
}

function render() {
    const colors = ['#FF2D55', '#00F0FF', '#FF9F0A', '#BF5AF2', '#30D158']; 
    const now = new Date();
    const currentMins = now.getHours() * 100 + now.getMinutes();
    let nextIdx = -1;
    let totalCal = 0;
    
    document.getElementById('mealContainer').innerHTML = scientificPlan.map((m, i) => {
        let isChk = app.checks[i];
        if(isChk) totalCal += (m.calories || m.c || 0);
        let color = colors[i % colors.length];
        
        let tVal = parseTime(m.time);
        if(nextIdx === -1 && tVal > currentMins && !isChk) nextIdx = i;
        let isNext = (i === nextIdx);
        
        let itemsHtml = (m.items || []).map(x => `
            <div class="ing-row">
                <div class="ing-left"><div class="ing-bullet"></div>${x.food}</div>
                <div class="ing-tag">${x.weight}</div>
            </div>`).join('');

        return `
        <div class="meal-card ${isChk?'checked':''} ${isNext?'highlight':''}" id="meal-${i}" style="--accent-color:${color}; --accent-rgb:${hexToRgb(color)}">
            <div class="next-badge">NEXT UP</div>
            <div class="check-box" onclick="togMeal(${i})">‚úì</div>
            <div class="mc-content" onclick="togMeal(${i})">
                <div class="mc-top">
                    <span class="mc-time" style="color:${color}">${m.time}</span>
                    <span class="mc-cal">${m.calories || 0} kcal</span>
                </div>
                <div class="mc-title">${m.n || getPhaseName(m.time)}</div>
                <div>${itemsHtml}</div>
            </div>
        </div>`;
    }).join('');

    app.custom.forEach(c => totalCal += c.c);
    document.getElementById('customList').innerHTML = app.custom.map((c,i) => `
        <div class="meal-card checked" style="--accent-color:#666; display:flex; flex-direction:row; align-items:center; padding:15px;">
            <div style="flex:1"><div class="mc-title" style="margin:0; font-size:1rem;">${c.n}</div><div class="mc-time" style="margin-top:5px; color:#666">${c.c} kcal</div></div>
            <div style="color:#FF3B30; font-weight:900; font-size:1.2rem; padding:10px; cursor:pointer;" onclick="delCust(${i})">‚úï</div>
        </div>
    `).join('') || '<div style="text-align:center; color:var(--text-sec); padding:20px;">No extra entries yet</div>';

    document.getElementById('dispStreak').innerText = app.streak;
    document.getElementById('waterVal').innerText = app.water.toFixed(1);
    document.getElementById('maidaStreakVal').innerText = app.maidaDates.length;
    document.getElementById('maidaStreakValHome').innerText = app.maidaDates.length;
    document.getElementById('maidaLog').innerHTML = app.maidaDates.map(d => `<div style="padding:15px; border-bottom:1px solid rgba(128,128,128,0.2); display:flex; justify-content:space-between; color:var(--text-sec);"><span>üìÖ ${d}</span><span style="color:#30D158">SUCCESS</span></div>`).join('') || '<div style="text-align:center; color:var(--text-sec); padding:20px;">No records yet</div>';

    let pct = Math.min(1, totalCal / app.target);
    document.getElementById('calPct').innerText = Math.round(pct * 100) + "%";
    document.getElementById('progCirc').style.strokeDashoffset = 175 - (175 * pct);
    
    // UPDATE STICKY BAR
    document.getElementById('mealPageCal').innerText = `${totalCal} / ${app.target}`;
    document.getElementById('sbFill').style.width = (pct * 100) + "%";

    renderShop();
    renderHistory();
}

function renderShop() {
    let pantry = {};
    const block = ['water', 'walk', 'run', 'gym', 'workout'];
    scientificPlan.forEach(m => {
        if(m.items) m.items.forEach(i => {
            let n = i.food; let w = i.weight;
            if(!n) return;
            let clean = n.replace(/\(.*?\)/g, "").trim();
            if(block.some(b => clean.toLowerCase().includes(b))) return;
            if(!pantry[clean]) pantry[clean] = [];
            pantry[clean].push(w);
        });
    });
    document.getElementById('shopContainer').innerHTML = Object.keys(pantry).map(k => `
        <div class="shop-row" onclick="this.classList.toggle('done')">
            <span style="font-weight:700;">${k}</span>
            <span class="shop-qty">${pantry[k].join(" + ")}</span>
        </div>
    `).join('') || '<div style="text-align:center; color:var(--text-sec); padding:20px;">Shopping list is empty</div>';
}

function renderHistory() {
    if(!app.history || app.history.length === 0) {
        document.getElementById('historyContainer').innerHTML = '<div style="text-align:center; color:var(--text-sec); padding:40px;">No history available yet.<br><small>Complete a day to see stats.</small></div>';
        return;
    }
    document.getElementById('historyContainer').innerHTML = app.history.map(h => {
        let dObj = new Date(h.date);
        let day = dObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        return `
        <div class="hist-row">
            <div class="hist-date">${day}</div>
            <div class="hist-data">
                <div class="hist-val">${h.cals} kcal</div>
                <div class="hist-sub">${h.water}L Water</div>
            </div>
        </div>`;
    }).join('');
}

function togMeal(i) {
    if(app.checks[i]) delete app.checks[i];
    else { 
        app.checks[i] = true; 
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#00E676', '#00C853', '#69F0AE'] }); 
    }
    save(); render();
}

function importPlan() {
    let input = document.getElementById('importArea').value.trim();
    if(!input) { showToast("Please paste code first"); return; }
    try {
        let clean = input;
        if(clean.includes('=')) clean = clean.split('=').pop().trim();
        if(clean.endsWith(';')) clean = clean.slice(0, -1);
        let newData = new Function("return " + clean)();
        if(Array.isArray(newData)) {
            scientificPlan = newData;
            app.checks = {}; 
            save(); render(); closeModal('settingsModal'); showToast("Plan Updated Successfully!");
        } else { showToast("Invalid format: Must be an Array [...]"); }
    } catch(e) { showToast("Error parsing code. Check syntax."); console.error(e); }
}

function scrollToNextMeal() {
    let el = document.querySelector('.meal-card.highlight');
    if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function nav(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
    if(id === 'p-meal') setTimeout(scrollToNextMeal, 300);
}

function markMaida() {
    let d = new Date().toISOString().split('T')[0];
    if(!app.maidaDates.includes(d)) {
        app.maidaDates.push(d); app.maidaDates.sort().reverse();
        save(); render(); showToast("Maida Streak +1"); 
        confetti({ particleCount: 150, spread: 80, colors: ['#2979FF', '#448AFF', '#82B1FF'] });
    } else { showToast("Already logged today!"); }
}

function modWater(n) { 
    app.water = parseFloat((app.water + n).toFixed(2)); 
    save(); render(); showToast(`+${n*1000}ml Water üíß`);
}

function addCustom() {
    let n = document.getElementById('cName').value.trim(); 
    let c = parseInt(document.getElementById('cCal').value);
    if(n && c) { 
        app.custom.push({n,c}); save(); render(); closeModal('customModal'); 
        showToast("Entry Added!");
        document.getElementById('cName').value = ''; document.getElementById('cCal').value = '';
    } else { showToast("Fill all fields!"); }
}

function delCust(i) { app.custom.splice(i,1); save(); render(); showToast("Entry Removed"); }
function editName() { let n = prompt("Enter your name:", app.userName); if(n && n.trim()) { app.userName = n.trim(); save(); init(); } }
function parseTime(val) {
    if(!val) return 0;
    let clean = val.toLowerCase().replace(/\s+/g, '');
    let isPM = clean.includes('pm'); let isAM = clean.includes('am');
    let timePart = clean.replace('am','').replace('pm','');
    let [h, m] = timePart.split(':').map(Number);
    if(isNaN(h)) return 0; if(isNaN(m)) m = 0;
    if(isPM && h !== 12) h += 12; if(isAM && h === 12) h = 0;
    return h * 100 + m;
}
function hexToRgb(hex) { var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '255,255,255'; }
function getPhaseName(t) {
    let val = parseTime(t);
    if(val < 600) return "Pre-Workout"; if(val < 800) return "Gym Session";
    if(val < 1000) return "Post-Workout"; if(val < 1200) return "Breakfast";
    if(val < 1500) return "Lunch"; if(val < 1800) return "Snack";
    if(val < 2000) return "Evening Meal"; return "Dinner";
}
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function save() { localStorage.setItem('fit_ultra_final_v20', JSON.stringify({app, plan: scientificPlan})); }
function saveSettings() { app.target = parseInt(document.getElementById('sTarg').value); save(); render(); closeModal('settingsModal'); showToast("Settings Saved!"); }
function resetApp() { if(confirm("Reset all data?")) { localStorage.removeItem('fit_ultra_final_v20'); location.reload(); } }
function showToast(m) { let t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }

init();
</script>
</body>
</html>