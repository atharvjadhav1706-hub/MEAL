<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pro FitHub: Ultimate</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
    /* --- CORE VARIABLES --- */
    :root {
        --bg: #000000;
        --text: #ffffff;
        --font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        
        /* DIMMED "DEEP" GRADIENTS */
        --g-orange: linear-gradient(145deg, rgba(255, 69, 0, 0.15), rgba(139, 0, 0, 0.4));
        --g-green:  linear-gradient(145deg, rgba(0, 200, 83, 0.15), rgba(0, 51, 0, 0.4));
        --g-blue:   linear-gradient(145deg, rgba(41, 121, 255, 0.15), rgba(0, 32, 96, 0.4));
        --g-purple: linear-gradient(145deg, rgba(191, 90, 242, 0.15), rgba(75, 0, 130, 0.4));
        --g-cyan:   linear-gradient(145deg, rgba(0, 229, 255, 0.15), rgba(0, 96, 100, 0.4));
        
        --card-border: 1px solid rgba(255, 255, 255, 0.08);
        --border-radius: 26px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
    
    body {
        background-color: var(--bg);
        color: var(--text);
        font-family: var(--font);
        margin: 0; padding: 0;
        padding-bottom: 50px;
        overflow-x: hidden;
    }

    /* --- ANIMATIONS --- */
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes float { 
        0% { transform: translateY(0px) rotate(0deg); } 
        50% { transform: translateY(-8px) rotate(3deg); } 
        100% { transform: translateY(0px) rotate(0deg); } 
    }
    @keyframes pulse-border { 
        0% { border-color: var(--accent-color); } 
        50% { border-color: #fff; box-shadow: 0 0 15px var(--accent-color); } 
        100% { border-color: var(--accent-color); } 
    }

    /* --- HEADER --- */
    .header {
        padding: 30px 24px 15px 24px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .welcome-sub { font-size: 0.7rem; font-weight: 700; color: #666; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 2px; }
    .app-title { font-size: 1.6rem; font-weight: 900; letter-spacing: -0.5px; color: #fff; text-shadow: 0 4px 12px rgba(0,0,0,0.8); }
    
    .settings-btn {
        width: 40px; height: 40px; border-radius: 50%;
        background: #111; border: 1px solid #222;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.1rem; cursor: pointer; transition: 0.2s;
    }
    .settings-btn:active { transform: scale(0.92); }

    /* --- DASHBOARD GRID --- */
    .grid { padding: 0 24px; display: flex; flex-direction: column; gap: 16px; }

    /* --- CARD DESIGN --- */
    .card {
        border-radius: var(--border-radius); 
        padding: 22px;
        position: relative; 
        overflow: hidden; 
        cursor: pointer; 
        display: flex; flex-direction: column; justify-content: center;
        border: var(--card-border);
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.8);
    }
    .card:active { transform: scale(0.98); opacity: 0.9; }

    .bg-icon {
        position: absolute; right: 15px; top: 50%;
        margin-top: -30px; 
        font-size: 4.5rem; opacity: 0.25; z-index: 0;
        filter: grayscale(0.2) drop-shadow(0 0 10px rgba(255,255,255,0.1));
        pointer-events: none;
        animation: float 5s ease-in-out infinite;
    }
    
    .card-content { position: relative; z-index: 2; }

    .c-streak { background: var(--g-orange); border-color: rgba(255, 69, 0, 0.3); }
    .c-meal { background: var(--g-green); border-color: rgba(0, 200, 83, 0.3); }
    .c-water { background: var(--g-cyan); border-color: rgba(0, 229, 255, 0.3); }
    .c-shop { background: var(--g-purple); border-color: rgba(191, 90, 242, 0.3); }
    .c-maida { background: var(--g-blue); border-color: rgba(41, 121, 255, 0.3); }

    .streak-lbl { font-size: 0.7rem; font-weight: 800; opacity: 0.7; letter-spacing: 1.5px; text-transform: uppercase; color: #ddd; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
    .streak-val { font-size: 2.6rem; font-weight: 900; line-height: 1; display:flex; align-items:baseline; gap:6px; margin-top: 6px; text-shadow: 0 4px 15px rgba(0,0,0,1); }
    .c-meal-title { font-size: 1.5rem; font-weight: 900; line-height: 1; margin-top: 6px; letter-spacing: -0.3px; text-shadow: 0 4px 15px rgba(0,0,0,1); }

    .mc-prog { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; z-index: 2; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)); }
    .mc-prog svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .mc-bg { stroke: rgba(255,255,255,0.1); }
    .mc-fill { stroke: #fff; stroke-dasharray: 175; stroke-dashoffset: 175; transition: 1s; stroke-linecap: round; }
    .mc-pct { font-size: 0.75rem; font-weight: 900; position: absolute; color: #fff; }

    .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .small-card { min-height: 150px; border-radius: var(--border-radius); padding: 20px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; backdrop-filter: blur(10px); border: var(--card-border); }
    .small-card .bg-icon { font-size: 3.5rem; right: 8px; opacity: 0.2; }
    .sc-val { font-size: 1.6rem; font-weight: 900; color: #fff; margin: 4px 0; text-shadow: 0 3px 10px rgba(0,0,0,0.9); }
    .sc-lbl { font-size: 0.65rem; color: #ccc; opacity: 0.8; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

    /* --- MEAL LIST --- */
    .meal-list { padding: 0 24px; margin-top: 10px; }

    .meal-card {
        background: #111; border: 1px solid #222; border-radius: 20px; margin-bottom: 20px;
        position: relative; overflow: hidden; padding-left: 5px; 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }

    .meal-card::before {
        content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px;
        background: var(--accent-color);
    }

    .meal-card.highlight {
        border: 2px solid var(--accent-color) !important;
        box-shadow: 0 0 25px rgba(var(--accent-rgb), 0.2);
        transform: scale(1.01); z-index: 5;
        animation: pulse-border 2s infinite;
        background: #141414;
    }
    .next-badge {
        position: absolute; top: 0; right: 55px;
        background: var(--tag-red); color: #fff;
        font-size: 0.6rem; font-weight: 900; padding: 5px 12px;
        border-bottom-left-radius: 12px; display: none; text-transform: uppercase;
        z-index: 10; letter-spacing: 0.5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .meal-card.highlight .next-badge { display: block; }

    .mc-content { padding: 20px; cursor: pointer; }
    .mc-top { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; padding-right: 40px; }
    .mc-time { color: var(--accent-color); font-weight: 800; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .mc-cal { background: #222; color: #fff; padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 0.7rem; border: 1px solid #333; }
    .mc-title { font-size: 1.4rem; font-weight: 800; color: #fff; margin-bottom: 15px; letter-spacing: -0.3px; line-height: 1.2; padding-right: 40px; }

    .ing-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #222; }
    .ing-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .ing-left { display: flex; align-items: center; color: #ccc; font-weight: 600; font-size: 0.95rem; }
    .ing-bullet { width: 6px; height: 6px; border-radius: 50%; background: var(--bullet); margin-right: 12px; flex-shrink: 0; }
    .ing-tag { background: rgba(255,255,255,0.08); color: #ddd; font-weight: 700; font-size: 0.8rem; padding: 5px 12px; border-radius: 8px; min-width: 60px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }

    .check-box {
        position: absolute; top: 18px; right: 18px; z-index: 10;
        width: 34px; height: 34px; border: 2px solid #333; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center; 
        cursor: pointer; background: #000; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 1.1rem; color: transparent;
    }
    .check-box:hover { border-color: #555; transform: scale(1.1); }
    .meal-card.checked { opacity: 0.4; filter: grayscale(1); }
    .meal-card.checked .check-box { background: #00E676; border-color: #00E676; color: #000; box-shadow: 0 0 15px rgba(0, 230, 118, 0.4); }

    .page { display: none; padding: 0; animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .page.active { display: block; }
    
    .nav-back {
        margin: 0 24px 15px 24px; display: inline-flex; align-items: center; gap: 8px;
        background: #111; padding: 12px 24px; border-radius: 30px; 
        font-weight: 700; color: #fff; cursor: pointer; border: 1px solid #222;
        transition: 0.2s;
    }
    .nav-back:active { transform: scale(0.95); }

    .shop-row { background: #111; padding: 18px; border-radius: 16px; margin-bottom: 10px; border: 1px solid #222; display: flex; justify-content: space-between; align-items: center; cursor:pointer;}
    .shop-row.done { opacity: 0.3; text-decoration: line-through; }
    .shop-qty { background: #222; padding: 5px 12px; border-radius: 8px; font-weight: 700; color: #00E676; font-size: 0.9rem; }
    
    .maida-btn { width: 100%; padding: 22px; margin-top: 25px; background: #fff; color: #000; font-weight: 900; font-size: 1.1rem; border: none; border-radius: 20px; cursor: pointer; transition: 0.2s; }
    .maida-btn:active { transform: scale(0.98); opacity: 0.9; }

    /* MODALS */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-box { background: #111; padding: 30px; width: 90%; max-width: 400px; border-radius: 28px; border: 1px solid #222; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    h2 { margin-top: 0; color: #fff; font-size: 1.5rem; }
    
    input, textarea { width: 100%; padding: 18px; background: #080808; border: 1px solid #222; color: #fff; border-radius: 14px; margin-bottom: 15px; font-family: var(--font); font-size: 1rem; outline: none; }
    input:focus { border-color: #444; }
    textarea { height: 150px; font-family: monospace; font-size: 0.8rem; line-height: 1.4; color: #00E676; }
    
    .btn { width: 100%; padding: 18px; background: #fff; color: #000; font-weight: 800; border: none; border-radius: 16px; cursor: pointer; margin-top: 5px; font-size: 1rem; }
    .btn:active { opacity: 0.8; }
    .btn-sec { background: #222; color: #fff; margin-top: 12px; }

    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1a1a1a; padding: 12px 24px; border-radius: 40px; z-index: 3000; border: 1px solid #333; opacity: 0; transition: 0.3s; pointer-events: none; font-weight: 700; display: flex; gap: 10px; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .toast.show { opacity: 1; top: 50px; }

    .water-actions { display: flex; gap: 10px; margin-top: 15px; }
    .water-btn {
        flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
        color: #fff; padding: 12px; border-radius: 12px; font-weight: 700;
        font-size: 0.9rem; cursor: pointer; transition: 0.2s;
        backdrop-filter: blur(4px);
    }
    .water-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
</style>
</head>
<body>

<div class="toast" id="toast"><span>‚úÖ</span> <span id="toastMsg">Saved</span></div>

<div id="p-home" class="page active">
    <div class="header">
        <div onclick="editName()">
            <div class="welcome-sub">WELCOME BACK,</div>
            <div class="app-title" id="userName">ATHARV ‚úé</div>
        </div>
        <div class="settings-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</div>
    </div>

    <div class="grid">
        <div class="card c-streak">
            <div class="bg-icon">üèÜ</div>
            <div class="card-content">
                <div class="streak-lbl">CURRENT STREAK</div>
                <div class="streak-val"><span id="dispStreak">0</span><span style="font-size:1.4rem; opacity:0.9; font-weight:800; text-shadow:none; margin-left:4px;">DAYS</span></div>
                <div style="font-size:0.75rem; font-weight:700; opacity:0.9; margin-top:8px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);">CONSISTENCY IS THE KEY</div>
            </div>
        </div>

        <div class="card c-meal" onclick="nav('p-meal')">
            <div class="bg-icon">ü•ó</div>
            <div class="card-content">
                <div class="streak-lbl">TODAY'S FUEL</div>
                <div class="c-meal-title">MEAL PLAN</div>
                <div style="font-size:0.8rem; font-weight:700; opacity:0.9; margin-top:6px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);">Tap to View Details</div>
            </div>
            <div class="mc-prog">
                <svg viewBox="0 0 70 70">
                    <circle class="mc-bg" cx="35" cy="35" r="28" stroke-width="8" fill="none" />
                    <circle class="mc-fill" id="progCirc" cx="35" cy="35" r="28" stroke-width="8" fill="none" />
                </svg>
                <div class="mc-pct" id="calPct">0%</div>
            </div>
        </div>

        <div class="split">
            <div class="small-card c-water">
                <div class="bg-icon">üç∂</div>
                <div class="card-content">
                    <div class="sc-lbl">HYDRATION</div>
                    <div class="sc-val"><span id="waterVal">0.0</span>L</div>
                    <div class="water-actions">
                        <button class="water-btn" onclick="event.stopPropagation(); modWater(0.25);">+250</button>
                        <button class="water-btn" onclick="event.stopPropagation(); modWater(0.5);">+500</button>
                    </div>
                </div>
            </div>
            <div class="small-card c-shop" onclick="nav('p-shop')">
                <div class="bg-icon">üìù</div>
                <div class="card-content">
                    <div class="sc-lbl">GROCERY</div>
                    <div class="sc-val">SHOPPING</div>
                    <div style="font-size:0.75rem; font-weight:700; opacity:0.8; margin-top:8px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);">View List</div>
                </div>
            </div>
        </div>

        <div class="card c-maida" onclick="nav('p-maida')">
            <div class="bg-icon">üö´</div>
            <div class="card-content">
                <div class="streak-lbl">DISCIPLINE TRACKER</div>
                <div class="c-meal-title">NO MAIDA</div>
                <div style="font-size:0.8rem; font-weight:700; opacity:0.9; margin-top:6px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);">
                    <span id="maidaStreakValHome">0</span> Days Clean
                </div>
            </div>
        </div>
    </div>
</div>

<div id="p-meal" class="page">
    <div class="nav-back" onclick="nav('p-home')">‚Üê DASHBOARD</div>
    <div class="header" style="padding-top:0;">
        <div class="app-title">TODAY'S FUEL</div>
        <div class="settings-btn" onclick="openModal('customModal')">+</div>
    </div>
    <div id="mealContainer" class="meal-list"></div>
    <div style="padding:22px; font-weight:800; color:#444; font-size:0.75rem; letter-spacing:1px; text-align:center;">CUSTOM LOGS</div>
    <div id="customList" class="meal-list"></div>
</div>

<div id="p-shop" class="page">
    <div class="nav-back" onclick="nav('p-home')">‚Üê DASHBOARD</div>
    <div class="header" style="padding-top:0;"><div class="app-title">SHOPPING LIST</div></div>
    <div id="shopContainer" class="grid"></div>
</div>

<div id="p-maida" class="page">
    <div class="nav-back" onclick="nav('p-home')">‚Üê DASHBOARD</div>
    <div class="header" style="padding-top:0;"><div class="app-title">NO MAIDA CHALLENGE</div></div>
    <div class="grid">
        <div class="card" style="background:#111; border:1px solid #222; text-align:center; padding:40px;">
            <div style="font-size:5rem; margin-bottom:10px;">üçû</div>
            <div style="font-size:3.5rem; font-weight:900;" id="maidaStreakVal">0</div>
            <div class="streak-lbl">DAYS CLEAN</div>
            <button class="maida-btn" onclick="markMaida()">‚úîÔ∏è MARK TODAY</button>
        </div>
        <div id="maidaLog" style="margin-top:20px;"></div>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-box">
        <h2>Settings</h2>
        <label style="font-size:0.85rem; color:#999; display:block; margin-bottom:8px;">Daily Calorie Target</label>
        <input type="number" id="sTarg" value="2450">
        <button class="btn" onclick="saveSettings()">SAVE SETTINGS</button>
        
        <div style="margin-top:25px; border-top:1px solid #222; padding-top:25px;">
            <h2 style="font-size:1rem; opacity:0.8;">Edit Meal Plan Code</h2>
            <textarea id="importArea" placeholder="Paste your array here:
[
  { time: '07:00 AM', calories: 200, items: [...] },
  ...
]"></textarea>
            <button class="btn" style="background:#222; color:#fff; border:1px solid #333;" onclick="importPlan()">UPDATE PLAN FROM CODE</button>
        </div>

        <button class="btn btn-sec" style="color:#ff4444;" onclick="resetApp()">RESET ALL DATA</button>
        <button class="btn btn-sec" onclick="closeModal('settingsModal')">CLOSE</button>
    </div>
</div>

<div id="customModal" class="modal">
    <div class="modal-box">
        <h2>Add Custom Entry</h2>
        <input type="text" id="cName" placeholder="Food Name">
        <input type="number" id="cCal" placeholder="Calories (Required)">
        <button class="btn" onclick="addCustom()">ADD ENTRY</button>
        <button class="btn btn-sec" onclick="closeModal('customModal')">CANCEL</button>
    </div>
</div>

<script>
/* DATA & LOGIC */
let scientificPlan = [
  { time: "05:30 AM", calories: 160, items: [{ food: "Large Banana", weight: "1 pc" }, { food: "Pumpkin Seeds", weight: "10g" }] },
  { time: "06:00 AM", calories: 0, items: [{ food: "Water", weight: "1 Liter" }] },
  { time: "08:15 AM", calories: 300, items: [{ food: "Whey Protein", weight: "2 Scoops" }, { food: "Apple", weight: "1 Medium" }, { food: "Creatine Monohydrate", weight: "5g" }] },
  { time: "11:00 AM", calories: 680, items: [{ food: "Whole Eggs", weight: "5 pcs" }, { food: "Chocolate Protein Oats", weight: "80g" }] },
  { time: "01:30 PM", calories: 250, items: [{ food: "Roasted Chana", weight: "50g" }, { food: "Orange", weight: "1 pc" }] },
  { time: "04:45 PM", calories: 350, items: [{ food: "Egg Whites", weight: "6 pcs" }, { food: "Whole Eggs", weight: "2 pcs" }, { food: "Kabuli Chana", weight: "50g" }] },
  { time: "07:00 PM", calories: 0, items: [{ food: "Evening Walk", weight: "45 Mins" }] },
  { time: "08:30 PM", calories: 430, items: [{ food: "Soya Chunks (Dry)", weight: "60g" }, { food: "Boiled Moong", weight: "100g" }, { food: "Cucumber Salad", weight: "100g" }] }
];

let app = { userName: "ATHARV", target: 2450, checks: {}, water: 0, custom: [], streak: 0, lastLog: "", maidaDates: [] };

function init() {
    const saved = localStorage.getItem('fit_ultra_final_v13');
    if(saved) {
        const p = JSON.parse(saved);
        app = {...app, ...p.app};
        if(p.plan && Array.isArray(p.plan) && p.plan.length > 0) scientificPlan = p.plan;
    }
    
    const today = new Date().toDateString();
    if(app.lastLog !== today) {
        let yest = new Date(); yest.setDate(yest.getDate()-1);
        if(app.lastLog === yest.toDateString()) app.streak++;
        else if(app.lastLog && app.lastLog !== today) app.streak = 0;
        app.checks = {}; app.water = 0; app.custom = []; app.lastLog = today;
        save();
    }
    
    document.getElementById('userName').innerText = app.userName + " ‚úé";
    document.getElementById('sTarg').value = app.target;
    render();
    setTimeout(scrollToNextMeal, 500);
}

function render() {
    // 1. MEAL LIST
    const colors = ['#FF2D55', '#00F0FF', '#FF9F0A', '#BF5AF2', '#30D158']; 
    const now = new Date();
    const currentMins = now.getHours() * 100 + now.getMinutes();
    let nextIdx = -1;
    let totalCal = 0;
    
    document.getElementById('mealContainer').innerHTML = scientificPlan.map((m, i) => {
        let isChk = app.checks[i];
        if(isChk) totalCal += (m.calories || m.c || 0);
        let color = colors[i % colors.length];
        
        let tVal = parseTime(m.time);
        if(nextIdx === -1 && tVal > currentMins && !isChk) nextIdx = i;
        let isNext = (i === nextIdx);
        
        let itemsHtml = (m.items || []).map(x => `
            <div class="ing-row">
                <div class="ing-left">
                    <div class="ing-bullet"></div>${x.food}
                </div>
                <div class="ing-tag">${x.weight}</div>
            </div>`).join('');

        return `
        <div class="meal-card ${isChk?'checked':''} ${isNext?'highlight':''}" id="meal-${i}" style="--accent-color:${color}; --accent-rgb:${hexToRgb(color)}">
            <div class="next-badge">NEXT UP</div>
            <div class="check-box" onclick="togMeal(${i})">‚úì</div>
            <div class="mc-content" onclick="togMeal(${i})">
                <div class="mc-top">
                    <span class="mc-time" style="color:${color}">${m.time}</span>
                    <span class="mc-cal">${m.calories || 0} kcal</span>
                </div>
                <div class="mc-title">${m.n || getPhaseName(m.time)}</div>
                <div>${itemsHtml}</div>
            </div>
        </div>`;
    }).join('');

    app.custom.forEach(c => totalCal += c.c);
    document.getElementById('customList').innerHTML = app.custom.map((c,i) => `
        <div class="meal-card checked" style="--accent-color:#666; display:flex; flex-direction:row; align-items:center; padding:15px;">
            <div style="flex:1"><div class="mc-title" style="margin:0; font-size:1rem;">${c.n}</div><div class="mc-time" style="margin-top:5px; color:#666">${c.c} kcal</div></div>
            <div style="color:#FF3B30; font-weight:900; font-size:1.2rem; padding:10px; cursor:pointer;" onclick="delCust(${i})">‚úï</div>
        </div>
    `).join('') || '<div style="text-align:center; color:#444; padding:20px;">No extra entries yet</div>';

    document.getElementById('dispStreak').innerText = app.streak;
    document.getElementById('waterVal').innerText = app.water.toFixed(1);
    document.getElementById('maidaStreakVal').innerText = app.maidaDates.length;
    document.getElementById('maidaStreakValHome').innerText = app.maidaDates.length;
    document.getElementById('maidaLog').innerHTML = app.maidaDates.map(d => `<div style="padding:15px; border-bottom:1px solid #222; display:flex; justify-content:space-between; color:#888;"><span>üìÖ ${d}</span><span style="color:#30D158">SUCCESS</span></div>`).join('') || '<div style="text-align:center; color:#444; padding:20px;">No records yet</div>';

    let pct = Math.min(1, totalCal / app.target);
    document.getElementById('calPct').innerText = Math.round(pct * 100) + "%";
    document.getElementById('progCirc').style.strokeDashoffset = 175 - (175 * pct);

    renderShop();
}

function renderShop() {
    let pantry = {};
    const block = ['water', 'walk', 'run', 'gym', 'workout'];
    scientificPlan.forEach(m => {
        if(m.items) m.items.forEach(i => {
            let n = i.food; let w = i.weight;
            if(!n) return;
            let clean = n.replace(/\(.*?\)/g, "").trim();
            if(block.some(b => clean.toLowerCase().includes(b))) return;
            if(!pantry[clean]) pantry[clean] = [];
            pantry[clean].push(w);
        });
    });
    document.getElementById('shopContainer').innerHTML = Object.keys(pantry).map(k => `
        <div class="shop-row" onclick="this.classList.toggle('done')">
            <span style="font-weight:700; color:#fff;">${k}</span>
            <span class="shop-qty">${pantry[k].join(" + ")}</span>
        </div>
    `).join('') || '<div style="text-align:center; color:#555; padding:20px;">Shopping list is empty</div>';
}

function togMeal(i) {
    if(app.checks[i]) delete app.checks[i];
    else { 
        app.checks[i] = true; 
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#00E676', '#00C853', '#69F0AE'] }); 
    }
    save(); render();
}

function importPlan() {
    let input = document.getElementById('importArea').value.trim();
    if(!input) { showToast("Please paste code first"); return; }
    
    try {
        // Safe evaluation of the array structure
        // This allows users to paste "const x = [...]" or just "[...]"
        let clean = input;
        if(clean.includes('=')) clean = clean.split('=').pop().trim();
        if(clean.endsWith(';')) clean = clean.slice(0, -1);
        
        // Allow flexible syntax (keys without quotes)
        let newData = new Function("return " + clean)();
        
        if(Array.isArray(newData)) {
            scientificPlan = newData;
            app.checks = {}; // Reset checks on new plan
            save();
            render();
            closeModal('settingsModal');
            showToast("Plan Updated Successfully!");
        } else {
            showToast("Invalid format: Must be an Array [...]");
        }
    } catch(e) {
        showToast("Error parsing code. Check syntax.");
        console.error(e);
    }
}

function scrollToNextMeal() {
    let el = document.querySelector('.meal-card.highlight');
    if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function nav(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
    if(id === 'p-meal') setTimeout(scrollToNextMeal, 300);
}

function markMaida() {
    let d = new Date().toISOString().split('T')[0];
    if(!app.maidaDates.includes(d)) {
        app.maidaDates.push(d); app.maidaDates.sort().reverse();
        save(); render(); showToast("Maida Streak +1"); 
        confetti({ particleCount: 150, spread: 80, colors: ['#2979FF', '#448AFF', '#82B1FF'] });
    } else {
        showToast("Already logged today!");
    }
}

function modWater(n) { 
    app.water = parseFloat((app.water + n).toFixed(2)); 
    save(); render(); showToast(`+${n}L Water ü•§`);
}

function addCustom() {
    let n = document.getElementById('cName').value.trim(); 
    let c = parseInt(document.getElementById('cCal').value);
    if(n && c) { 
        app.custom.push({n,c}); save(); render(); closeModal('customModal'); 
        showToast("Entry Added!");
        document.getElementById('cName').value = ''; document.getElementById('cCal').value = '';
    } else { showToast("Fill all fields!"); }
}

function delCust(i) { app.custom.splice(i,1); save(); render(); showToast("Entry Removed"); }

function editName() { 
    let n = prompt("Enter your name:", app.userName); 
    if(n && n.trim()) { app.userName = n.trim(); save(); init(); } 
}

function parseTime(val) {
    if(!val) return 0;
    // Robust parsing for various formats: "5:30 AM", "17:30", "5:30", "05:30am"
    let clean = val.toLowerCase().replace(/\s+/g, '');
    let isPM = clean.includes('pm');
    let isAM = clean.includes('am');
    let timePart = clean.replace('am','').replace('pm','');
    
    let [h, m] = timePart.split(':').map(Number);
    if(isNaN(h)) return 0;
    if(isNaN(m)) m = 0;
    
    if(isPM && h !== 12) h += 12;
    if(isAM && h === 12) h = 0;
    // Fallback for 24h if no AM/PM
    if(!isPM && !isAM && h < 5) { 
        // Heuristic: if time is 1:00, 2:00, 3:00, assume PM for lunch unless explicitly AM
        // But for meal plans starting at 5am, let's assume raw numbers < 5 are PM? 
        // No, keep standard 24h logic. 13:00 = 1300.
    }
    
    return h * 100 + m;
}

function hexToRgb(hex) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '255,255,255';
}

function getPhaseName(t) {
    let val = parseTime(t);
    if(val < 600) return "Pre-Workout";
    if(val < 800) return "Gym Session";
    if(val < 1000) return "Post-Workout";
    if(val < 1200) return "Breakfast";
    if(val < 1500) return "Lunch";
    if(val < 1800) return "Snack";
    if(val < 2000) return "Evening Meal";
    return "Dinner";
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function save() { localStorage.setItem('fit_ultra_final_v13', JSON.stringify({app, plan: scientificPlan})); }
function saveSettings() { 
    app.target = parseInt(document.getElementById('sTarg').value); 
    save(); render(); closeModal('settingsModal'); showToast("Settings Saved!");
}
function resetApp() { 
    if(confirm("Reset all data?")) { localStorage.removeItem('fit_ultra_final_v13'); location.reload(); } 
}
function showToast(m) { 
    let t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=m; 
    t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); 
}

init();
</script>
</body>
</html>